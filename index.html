<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisador SPED-EFD - Detalhamento por Ano/M√™s</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary-color: #64748b;
            --accent-color: #ef4444;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --light-color: #f8fafc;
            --border-color: #e2e8f0;
            --text-color: #334155;
            --text-light: #64748b;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        
        body {
            background-color: #f1f5f9;
            color: var(--text-color);
            line-height: 1.6;
            font-size: 14px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            padding: 30px 0;
            text-align: center;
            border-radius: 0 0 12px 12px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }
        
        h1 {
            font-size: 2.2rem;
            margin-bottom: 8px;
            font-weight: 700;
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            font-weight: 400;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 24px;
            margin-bottom: 24px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border: 1px solid var(--border-color);
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .card-title {
            font-size: 1.4rem;
            color: var(--primary-color);
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
        }
        
        .upload-area {
            border: 2px dashed #cbd5e1;
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: #f8fafc;
        }
        
        .upload-area:hover, .upload-area.dragover {
            border-color: var(--primary-color);
            background-color: #eff6ff;
        }
        
        .upload-icon {
            font-size: 48px;
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s ease;
            text-decoration: none;
            text-align: center;
        }
        
        .btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-success {
            background: var(--success-color);
        }
        
        .btn-success:hover {
            background: #0da271;
        }
        
        .btn-danger {
            background: var(--accent-color);
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .btn-warning {
            background: var(--warning-color);
        }
        
        .btn-warning:hover {
            background: #d97706;
        }
        
        .btn-outline {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }
        
        .btn-outline:hover {
            background: #f8fafc;
        }
        
        .btn-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        .file-info {
            margin-top: 15px;
            padding: 16px;
            background-color: #f8fafc;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        
        .file-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }
        
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: white;
            margin-bottom: 6px;
            border-radius: 6px;
            border-left: 4px solid var(--primary-color);
            font-size: 0.9rem;
        }
        
        .file-item.error {
            border-left-color: var(--accent-color);
            background-color: #fef2f2;
        }
        
        .file-item.success {
            border-left-color: var(--success-color);
            background-color: #f0fdf4;
        }
        
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        
        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            font-size: 0.9rem;
        }
        
        th, td {
            border: 1px solid var(--border-color);
            padding: 10px 12px;
            text-align: left;
        }
        
        th {
            background-color: #f8fafc;
            color: var(--text-color);
            font-weight: 600;
            position: sticky;
            top: 0;
            border-bottom: 2px solid var(--border-color);
        }
        
        tr:nth-child(even) {
            background-color: #f8fafc;
        }
        
        tr:hover {
            background-color: #f1f5f9;
        }
        
        .results-section {
            display: none;
        }
        
        .summary-card {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 25px;
        }
        
        .summary-item {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: var(--shadow);
            text-align: center;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 120px;
        }
        
        .summary-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--primary-color);
            margin: 10px 0;
            line-height: 1.2;
        }
        
        .summary-label {
            color: var(--text-light);
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .error {
            color: var(--accent-color);
            background-color: #fef2f2;
            padding: 12px 16px;
            border-radius: 6px;
            margin-top: 15px;
            display: none;
            border: 1px solid #fecaca;
            font-size: 0.9rem;
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: var(--text-light);
            font-size: 0.85rem;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
            gap: 4px;
        }
        
        .tab {
            padding: 10px 16px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 0.9rem;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
            color: var(--text-light);
            font-weight: 500;
            border-radius: 6px 6px 0 0;
        }
        
        .tab:hover {
            color: var(--primary-color);
            background: #f1f5f9;
        }
        
        .tab.active {
            border-bottom-color: var(--primary-color);
            color: var(--primary-color);
            font-weight: 600;
            background: #eff6ff;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .debug-info {
            background: #fffbeb;
            border: 1px solid #fed7aa;
            border-radius: 6px;
            padding: 12px;
            margin-top: 10px;
            font-size: 0.85rem;
            display: none;
        }
        
        .filter-section {
            margin-bottom: 20px;
            padding: 16px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        
        .filter-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 12px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--text-color);
            font-size: 0.9rem;
        }
        
        .filter-input, .filter-select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.9rem;
            transition: border-color 0.2s;
        }
        
        .filter-input:focus, .filter-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .registro-badge {
            display: inline-block;
            padding: 4px 8px;
            background: var(--primary-color);
            color: white;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .item-highlight {
            background-color: #eff6ff !important;
            border-left: 4px solid var(--primary-color);
        }
        
        .valor-cell {
            font-weight: 600;
            color: var(--success-color);
        }
        
        .info-box {
            background: #eff6ff;
            border-left: 4px solid var(--primary-color);
            padding: 16px;
            margin: 16px 0;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        .periodo-badge {
            display: inline-block;
            padding: 4px 8px;
            background: var(--warning-color);
            color: white;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .total-row {
            background-color: #f0fdf4 !important;
            font-weight: 600;
            border-top: 2px solid var(--success-color);
        }
        
        .section-title {
            font-size: 1.2rem;
            color: var(--primary-color);
            margin-bottom: 16px;
            font-weight: 600;
        }
        
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .status-success {
            background: #f0fdf4;
            color: var(--success-color);
            border: 1px solid #bbf7d0;
        }
        
        .status-error {
            background: #fef2f2;
            color: var(--accent-color);
            border: 1px solid #fecaca;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-light);
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        .summary-value-large {
            font-size: 1.5rem;
            word-break: break-all;
            overflow-wrap: break-word;
        }
        
        .btn-group-fixed {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 20px;
            justify-content: flex-start;
            align-items: center;
        }
        
        .btn-fixed {
            flex: 0 1 auto;
            min-width: 140px;
        }

        /* Estilos para pagina√ß√£o */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .pagination-info {
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .pagination-btn {
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pagination-btn:hover:not(:disabled) {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .performance-warning {
            background: #fffbeb;
            border: 1px solid #fed7aa;
            border-radius: 6px;
            padding: 12px;
            margin: 10px 0;
            font-size: 0.9rem;
            display: none;
        }

        .batch-processing {
            display: none;
            text-align: center;
            padding: 20px;
            background: #f8fafc;
            border-radius: 8px;
            margin: 10px 0;
        }

        .batch-progress {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            margin: 10px 0;
            overflow: hidden;
        }

        .batch-progress-bar {
            height: 100%;
            background: var(--primary-color);
            transition: width 0.3s ease;
        }

        .current-file {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-top: 8px;
        }

        .view-consolidada .periodo-column {
            display: none;
        }

        .view-consolidada .periodo-badge {
            display: none;
        }

        @media (max-width: 1024px) {
            .summary-card {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .filter-row {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .btn-group, .btn-group-fixed {
                flex-direction: column;
            }
            
            .btn, .btn-fixed {
                width: 100%;
            }
            
            table {
                display: block;
                overflow-x: auto;
            }
            
            .tabs {
                flex-direction: column;
                gap: 0;
            }
            
            .tab {
                text-align: left;
                border-bottom: 1px solid var(--border-color);
                border-radius: 0;
            }
            
            .filter-row {
                grid-template-columns: 1fr;
            }
            
            .summary-card {
                grid-template-columns: 1fr;
            }

            .pagination {
                flex-wrap: wrap;
            }
        }
        
        @media (max-width: 480px) {
            .summary-card {
                grid-template-columns: 1fr;
            }
            
            .summary-value {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>Analisador SPED-EFD</h1>
            <p class="subtitle">Detalhamento por Ano/M√™s - An√°lise completa com separa√ß√£o por per√≠odo</p>
        </div>
    </header>
    
    <div class="container">
        <div class="card">
            <h2 class="card-title">Carregar Arquivos SPED-EFD</h2>
            
            <div class="info-box">
                <strong>Como funciona:</strong> O sistema identifica automaticamente:
                <ul style="margin: 10px 0 0 20px;">
                    <li><strong>Separa√ß√£o por Ano/M√™s</strong> de cada arquivo</li>
                    <li><strong>Registro 0200:</strong> C√≥digo e descri√ß√£o do item</li>
                    <li><strong>Registro C170:</strong> Valores, quantidades e complementos</li>
                    <li><strong>Totais por tipo de registro</strong> em cada per√≠odo</li>
                    <li><strong>Todos os registros</strong> do SPED-EFD</li>
                </ul>
            </div>
            
            <div class="performance-warning" id="performanceWarning">
                <strong>‚ö†Ô∏è Aviso de Performance:</strong> Muitos arquivos detectados. O processamento pode levar alguns minutos. Recomendado processar em lotes menores.
            </div>
            
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üìÅ</div>
                <p>Clique aqui ou arraste m√∫ltiplos arquivos SPED-EFD para an√°lise</p>
                <p><small>Arquivos aceitos: .txt (m√∫ltipla sele√ß√£o permitida)</small></p>
                <input type="file" id="fileInput" accept=".txt" multiple style="display: none;">
            </div>
            
            <div class="file-info">
                <p><strong>Arquivos carregados:</strong> <span id="fileCount">0</span></p>
                <div class="file-list" id="fileList"></div>
            </div>

            <div class="batch-processing" id="batchProcessing">
                <div class="spinner"></div>
                <p>Processando em lote: <span id="batchProgressText">0%</span></p>
                <div class="batch-progress">
                    <div class="batch-progress-bar" id="batchProgressBar" style="width: 0%"></div>
                </div>
                <p class="current-file" id="currentFile">Processando arquivos...</p>
                <p><small>Processando arquivos... Isso pode levar alguns minutos para grandes volumes</small></p>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-success" id="processBtn" disabled>
                    <span>Processar Arquivos</span>
                </button>
                <button class="btn btn-outline" id="clearBtn">
                    <span>Limpar Arquivos</span>
                </button>
            </div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Processando arquivos...</p>
            </div>
            
            <div class="error" id="error"></div>
            
            <div class="debug-info" id="debugInfo">
                <strong>Informa√ß√µes de Debug:</strong>
                <div id="debugContent"></div>
            </div>
        </div>
        
        <div class="results-section" id="resultsSection">
            <div class="card">
                <h2 class="card-title">Resumo Geral por Per√≠odo</h2>
                <div class="summary-card">
                    <div class="summary-item">
                        <div class="summary-label">Arquivos Processados</div>
                        <div class="summary-value" id="processedFiles">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Per√≠odos Encontrados</div>
                        <div class="summary-value" id="totalPeriodos">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Total de Registros</div>
                        <div class="summary-value" id="totalRegistros">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Valor Total Geral</div>
                        <div class="summary-value summary-value-large" id="totalValue">R$ 0,00</div>
                    </div>
                </div>
                
                <div class="btn-group-fixed">
                    <button class="btn btn-success btn-fixed" id="exportBtn">
                        <span>Exportar para Excel</span>
                    </button>
                    <button class="btn btn-fixed" id="applyFiltersBtn">
                        <span>Aplicar Filtros</span>
                    </button>
                    <button class="btn btn-outline btn-fixed" id="togglePeriodoView">
                        <span>Vista Consolidada</span>
                    </button>
                    <button class="btn btn-outline btn-fixed" id="debugToggle">
                        <span>Mostrar Debug</span>
                    </button>
                    <button class="btn btn-danger btn-fixed" id="resetBtn">
                        <span>Nova An√°lise</span>
                    </button>
                </div>
            </div>

            <div class="filter-section">
                <h3 class="section-title">Filtros Avan√ßados</h3>
                <div class="filter-row">
                    <div class="filter-group">
                        <label class="filter-label">Ano</label>
                        <select class="filter-select" id="filterAno">
                            <option value="">Todos os anos</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">M√™s</label>
                        <select class="filter-select" id="filterMes">
                            <option value="">Todos os meses</option>
                            <option value="01">Janeiro</option>
                            <option value="02">Fevereiro</option>
                            <option value="03">Mar√ßo</option>
                            <option value="04">Abril</option>
                            <option value="05">Maio</option>
                            <option value="06">Junho</option>
                            <option value="07">Julho</option>
                            <option value="08">Agosto</option>
                            <option value="09">Setembro</option>
                            <option value="10">Outubro</option>
                            <option value="11">Novembro</option>
                            <option value="12">Dezembro</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Tipo de Registro</label>
                        <select class="filter-select" id="filterRegistro">
                            <option value="">Todos os registros</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">C√≥digo do Item</label>
                        <input type="text" class="filter-input" id="filterItemCodigo" placeholder="C√≥digo exato do item">
                    </div>
                </div>
                <div class="filter-row">
                    <div class="filter-group">
                        <label class="filter-label">Descri√ß√£o do Item</label>
                        <input type="text" class="filter-input" id="filterItemDescricao" placeholder="Parte da descri√ß√£o">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Valor M√≠nimo</label>
                        <input type="number" class="filter-input" id="filterValorMin" placeholder="0.00" step="0.01" min="0">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Valor M√°ximo</label>
                        <input type="number" class="filter-input" id="filterValorMax" placeholder="0.00" step="0.01" min="0">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Unidade de Medida</label>
                        <input type="text" class="filter-input" id="filterUnidade" placeholder="UN, KG, PC, etc.">
                    </div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-outline" id="clearFiltersBtn">
                        <span>Limpar Filtros</span>
                    </button>
                </div>
            </div>
            
            <div class="tabs">
                <button class="tab active" data-tab="periodo">Resumo por Per√≠odo</button>
                <button class="tab" data-tab="registros">Totais por Registro</button>
                <button class="tab" data-tab="itens">Itens com Valores</button>
                <button class="tab" data-tab="c170">Registros C170</button>
                <button class="tab" data-tab="0200">Cadastro de Itens</button>
                <button class="tab" data-tab="details">Todos os Registros</button>
                <button class="tab" data-tab="files">Detalhes por Arquivo</button>
            </div>
            
            <div class="tab-content active" id="periodoTab">
                <div class="card">
                    <h2 class="card-title">Resumo por Per√≠odo (Ano/M√™s)</h2>
                    <div class="pagination" id="periodoPagination" style="display: none;">
                        <button class="pagination-btn" id="periodoFirst">Primeira</button>
                        <button class="pagination-btn" id="periodoPrev">Anterior</button>
                        <span class="pagination-info" id="periodoPageInfo">P√°gina 1 de 1</span>
                        <button class="pagination-btn" id="periodoNext">Pr√≥xima</button>
                        <button class="pagination-btn" id="periodoLast">√öltima</button>
                        <input type="number" class="pagination-input" id="periodoPageInput" min="1" value="1">
                        <button class="pagination-btn" id="periodoGo">Ir</button>
                    </div>
                    <table id="periodoTable">
                        <thead>
                            <tr>
                                <th>Per√≠odo</th>
                                <th>Arquivos</th>
                                <th>Total de Registros</th>
                                <th>Tipos de Registros</th>
                                <th>Valor Total</th>
                                <th>Itens Cadastrados</th>
                                <th>Registros C170</th>
                                <th>Valor C170</th>
                            </tr>
                        </thead>
                        <tbody id="periodoTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="tab-content" id="registrosTab">
                <div class="card">
                    <h2 class="card-title">Totais por Tipo de Registro</h2>
                    <div class="pagination" id="registrosPagination" style="display: none;">
                        <button class="pagination-btn" id="registrosFirst">Primeira</button>
                        <button class="pagination-btn" id="registrosPrev">Anterior</button>
                        <span class="pagination-info" id="registrosPageInfo">P√°gina 1 de 1</span>
                        <button class="pagination-btn" id="registrosNext">Pr√≥xima</button>
                        <button class="pagination-btn" id="registrosLast">√öltima</button>
                        <input type="number" class="pagination-input" id="registrosPageInput" min="1" value="1">
                        <button class="pagination-btn" id="registrosGo">Ir</button>
                    </div>
                    <table id="registrosTable">
                        <thead>
                            <tr>
                                <th>Tipo de Registro</th>
                                <th>Descri√ß√£o</th>
                                <th>Quantidade Total</th>
                                <th>Valor Total</th>
                                <th>Per√≠odos</th>
                                <th>Arquivos</th>
                            </tr>
                        </thead>
                        <tbody id="registrosTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="tab-content" id="itensTab">
                <div class="card">
                    <h2 class="card-title">Itens com Valores Associados</h2>
                    <p><em>Associa√ß√£o entre registros 0200 (cadastro) e C170 (valores) por per√≠odo</em></p>
                    <div class="pagination" id="itensPagination" style="display: none;">
                        <button class="pagination-btn" id="itensFirst">Primeira</button>
                        <button class="pagination-btn" id="itensPrev">Anterior</button>
                        <span class="pagination-info" id="itensPageInfo">P√°gina 1 de 1</span>
                        <button class="pagination-btn" id="itensNext">Pr√≥xima</button>
                        <button class="pagination-btn" id="itensLast">√öltima</button>
                        <input type="number" class="pagination-input" id="itensPageInput" min="1" value="1">
                        <button class="pagination-btn" id="itensGo">Ir</button>
                    </div>
                    <table id="itensTable">
                        <thead>
                            <tr>
                                <th>C√≥digo</th>
                                <th>Descri√ß√£o</th>
                                <th>Unidade</th>
                                <th class="periodo-column">Per√≠odo</th>
                                <th>Quantidade Total</th>
                                <th>Valor Total</th>
                                <th>Valor Unit√°rio M√©dio</th>
                                <th>Qtde. C170</th>
                                <th>Arquivos</th>
                            </tr>
                        </thead>
                        <tbody id="itensTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="tab-content" id="c170Tab">
                <div class="card">
                    <h2 class="card-title">Registros C170 - Itens de Documentos</h2>
                    <div class="pagination" id="c170Pagination" style="display: none;">
                        <button class="pagination-btn" id="c170First">Primeira</button>
                        <button class="pagination-btn" id="c170Prev">Anterior</button>
                        <span class="pagination-info" id="c170PageInfo">P√°gina 1 de 1</span>
                        <button class="pagination-btn" id="c170Next">Pr√≥xima</button>
                        <button class="pagination-btn" id="c170Last">√öltima</button>
                        <input type="number" class="pagination-input" id="c170PageInput" min="1" value="1">
                        <button class="pagination-btn" id="c170Go">Ir</button>
                    </div>
                    <table id="c170Table">
                        <thead>
                            <tr>
                                <th class="periodo-column">Per√≠odo</th>
                                <th>Arquivo</th>
                                <th>C√≥digo Item</th>
                                <th>Descri√ß√£o Item</th>
                                <th>Descri√ß√£o Complementar</th>
                                <th>Quantidade</th>
                                <th>Unidade</th>
                                <th>Valor Item</th>
                                <th>Valor Desconto</th>
                                <th>Base ICMS</th>
                                <th>Valor ICMS</th>
                            </tr>
                        </thead>
                        <tbody id="c170TableBody">
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="tab-content" id="tab0200">
                <div class="card">
                    <h2 class="card-title">Cadastro de Itens (Registro 0200)</h2>
                    <div class="pagination" id="pagination0200" style="display: none;">
                        <button class="pagination-btn" id="first0200">Primeira</button>
                        <button class="pagination-btn" id="prev0200">Anterior</button>
                        <span class="pagination-info" id="pageInfo0200">P√°gina 1 de 1</span>
                        <button class="pagination-btn" id="next0200">Pr√≥xima</button>
                        <button class="pagination-btn" id="last0200">√öltima</button>
                        <input type="number" class="pagination-input" id="pageInput0200" min="1" value="1">
                        <button class="pagination-btn" id="go0200">Ir</button>
                    </div>
                    <table id="table0200">
                        <thead>
                            <tr>
                                <th class="periodo-column">Per√≠odo</th>
                                <th>Arquivo</th>
                                <th>C√≥digo Item</th>
                                <th>Descri√ß√£o</th>
                                <th>C√≥digo Barras</th>
                                <th>Unidade</th>
                                <th>Tipo Item</th>
                                <th>C√≥digo NCM</th>
                            </tr>
                        </thead>
                        <tbody id="table0200Body">
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="tab-content" id="detailsTab">
                <div class="card">
                    <h2 class="card-title">Todos os Registros Detalhados</h2>
                    <div class="pagination" id="detailsPagination" style="display: none;">
                        <button class="pagination-btn" id="detailsFirst">Primeira</button>
                        <button class="pagination-btn" id="detailsPrev">Anterior</button>
                        <span class="pagination-info" id="detailsPageInfo">P√°gina 1 de 1</span>
                        <button class="pagination-btn" id="detailsNext">Pr√≥xima</button>
                        <button class="pagination-btn" id="detailsLast">√öltima</button>
                        <input type="number" class="pagination-input" id="detailsPageInput" min="1" value="1">
                        <button class="pagination-btn" id="detailsGo">Ir</button>
                    </div>
                    <table id="detailsTable">
                        <thead>
                            <tr>
                                <th class="periodo-column">Per√≠odo</th>
                                <th>Arquivo</th>
                                <th>Registro</th>
                                <th>Item C√≥digo</th>
                                <th>Item Descri√ß√£o</th>
                                <th>Valor</th>
                                <th>Data</th>
                                <th>Linha Completa</th>
                            </tr>
                        </thead>
                        <tbody id="detailsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="tab-content" id="filesTab">
                <div class="card">
                    <h2 class="card-title">Detalhes por Arquivo</h2>
                    <div class="pagination" id="filesPagination" style="display: none;">
                        <button class="pagination-btn" id="filesFirst">Primeira</button>
                        <button class="pagination-btn" id="filesPrev">Anterior</button>
                        <span class="pagination-info" id="filesPageInfo">P√°gina 1 de 1</span>
                        <button class="pagination-btn" id="filesNext">Pr√≥xima</button>
                        <button class="pagination-btn" id="filesLast">√öltima</button>
                        <input type="number" class="pagination-input" id="filesPageInput" min="1" value="1">
                        <button class="pagination-btn" id="filesGo">Ir</button>
                    </div>
                    <table id="filesTable">
                        <thead>
                            <tr>
                                <th>Arquivo</th>
                                <th>Per√≠odo</th>
                                <th>M√™s/Ano</th>
                                <th>Total de Registros</th>
                                <th>Tipos de Registros</th>
                                <th>Valor Total</th>
                                <th>Itens 0200</th>
                                <th>Registros C170</th>
                            </tr>
                        </thead>
                        <tbody id="filesTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <footer>
        <div class="container">
            <p>Analisador SPED-EFD - Detalhamento por Ano/M√™s &copy; 2025 - An√°lise completa com separa√ß√£o por per√≠odo</p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Configura√ß√µes de performance
            const PERFORMANCE_CONFIG = {
                BATCH_SIZE: 50,
                PAGE_SIZE: 100,
                VIRTUAL_SCROLL_THRESHOLD: 1000
            };

            // Elementos da interface
            const fileInput = document.getElementById('fileInput');
            const uploadArea = document.getElementById('uploadArea');
            const fileCount = document.getElementById('fileCount');
            const fileList = document.getElementById('fileList');
            const processBtn = document.getElementById('processBtn');
            const clearBtn = document.getElementById('clearBtn');
            const resultsSection = document.getElementById('resultsSection');
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const exportBtn = document.getElementById('exportBtn');
            const resetBtn = document.getElementById('resetBtn');
            const debugToggle = document.getElementById('debugToggle');
            const debugInfo = document.getElementById('debugInfo');
            const debugContent = document.getElementById('debugContent');
            const applyFiltersBtn = document.getElementById('applyFiltersBtn');
            const clearFiltersBtn = document.getElementById('clearFiltersBtn');
            const togglePeriodoView = document.getElementById('togglePeriodoView');
            const batchProcessing = document.getElementById('batchProcessing');
            const batchProgressBar = document.getElementById('batchProgressBar');
            const batchProgressText = document.getElementById('batchProgressText');
            const currentFile = document.getElementById('currentFile');
            const performanceWarning = document.getElementById('performanceWarning');
            
            // Elementos de resumo
            const processedFiles = document.getElementById('processedFiles');
            const totalPeriodos = document.getElementById('totalPeriodos');
            const totalRegistros = document.getElementById('totalRegistros');
            const totalValue = document.getElementById('totalValue');
            
            // Filtros
            const filterAno = document.getElementById('filterAno');
            const filterMes = document.getElementById('filterMes');
            const filterRegistro = document.getElementById('filterRegistro');
            const filterItemCodigo = document.getElementById('filterItemCodigo');
            const filterItemDescricao = document.getElementById('filterItemDescricao');
            const filterValorMin = document.getElementById('filterValorMin');
            const filterValorMax = document.getElementById('filterValorMax');
            const filterUnidade = document.getElementById('filterUnidade');
            
            // Tabelas
            const periodoTableBody = document.getElementById('periodoTableBody');
            const registrosTableBody = document.getElementById('registrosTableBody');
            const itensTableBody = document.getElementById('itensTableBody');
            const c170TableBody = document.getElementById('c170TableBody');
            const table0200Body = document.getElementById('table0200Body');
            const detailsTableBody = document.getElementById('detailsTableBody');
            const filesTableBody = document.getElementById('filesTableBody');
            
            // Tabs
            const tabs = document.querySelectorAll('.tab');
            
            let filesData = [];
            let analysisData = null;
            let filteredData = null;
            let debugMode = false;
            let periodoView = true;
            
            // Estado de pagina√ß√£o
            const paginationState = {
                periodo: { currentPage: 1, totalPages: 1, pageSize: PERFORMANCE_CONFIG.PAGE_SIZE },
                registros: { currentPage: 1, totalPages: 1, pageSize: PERFORMANCE_CONFIG.PAGE_SIZE },
                itens: { currentPage: 1, totalPages: 1, pageSize: PERFORMANCE_CONFIG.PAGE_SIZE },
                c170: { currentPage: 1, totalPages: 1, pageSize: PERFORMANCE_CONFIG.PAGE_SIZE },
                '0200': { currentPage: 1, totalPages: 1, pageSize: PERFORMANCE_CONFIG.PAGE_SIZE },
                details: { currentPage: 1, totalPages: 1, pageSize: PERFORMANCE_CONFIG.PAGE_SIZE },
                files: { currentPage: 1, totalPages: 1, pageSize: PERFORMANCE_CONFIG.PAGE_SIZE }
            };

            // Eventos
            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                if (e.dataTransfer.files.length) handleFiles(e.dataTransfer.files);
            });
            
            fileInput.addEventListener('change', () => {
                if (fileInput.files.length) handleFiles(fileInput.files);
            });
            
            processBtn.addEventListener('click', processFiles);
            clearBtn.addEventListener('click', clearFiles);
            exportBtn.addEventListener('click', exportToExcel);
            resetBtn.addEventListener('click', resetAnalysis);
            debugToggle.addEventListener('click', toggleDebug);
            applyFiltersBtn.addEventListener('click', applyFilters);
            clearFiltersBtn.addEventListener('click', clearFilters);
            togglePeriodoView.addEventListener('click', togglePeriodoViewHandler);
            
            // Eventos para valida√ß√£o de filtros
            filterValorMin.addEventListener('input', validateValorFilters);
            filterValorMax.addEventListener('input', validateValorFilters);
            
            // Eventos para tabs
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    tabs.forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Corrigir IDs inconsistentes
                    let contentId = tabId + 'Tab';
                    if (tabId === '0200') {
                        contentId = 'tab0200';
                    }
                    
                    const contentElement = document.getElementById(contentId);
                    if (contentElement) {
                        contentElement.classList.add('active');
                    }
                });
            });

            // Configurar eventos de pagina√ß√£o para cada aba
            setupPaginationEvents('periodo');
            setupPaginationEvents('registros');
            setupPaginationEvents('itens');
            setupPaginationEvents('c170');
            setupPaginationEvents('0200');
            setupPaginationEvents('details');
            setupPaginationEvents('files');

            function setupPaginationEvents(tabName) {
                // IDs corrigidos para evitar problemas
                let firstBtn, prevBtn, nextBtn, lastBtn, pageInput, goBtn;
                
                if (tabName === '0200') {
                    firstBtn = document.getElementById('first0200');
                    prevBtn = document.getElementById('prev0200');
                    nextBtn = document.getElementById('next0200');
                    lastBtn = document.getElementById('last0200');
                    pageInput = document.getElementById('pageInput0200');
                    goBtn = document.getElementById('go0200');
                } else {
                    firstBtn = document.getElementById(`${tabName}First`);
                    prevBtn = document.getElementById(`${tabName}Prev`);
                    nextBtn = document.getElementById(`${tabName}Next`);
                    lastBtn = document.getElementById(`${tabName}Last`);
                    pageInput = document.getElementById(`${tabName}PageInput`);
                    goBtn = document.getElementById(`${tabName}Go`);
                }

                if (firstBtn) firstBtn.addEventListener('click', () => changePage(tabName, 1));
                if (prevBtn) prevBtn.addEventListener('click', () => changePage(tabName, paginationState[tabName].currentPage - 1));
                if (nextBtn) nextBtn.addEventListener('click', () => changePage(tabName, paginationState[tabName].currentPage + 1));
                if (lastBtn) lastBtn.addEventListener('click', () => changePage(tabName, paginationState[tabName].totalPages));
                if (goBtn && pageInput) {
                    goBtn.addEventListener('click', () => {
                        const page = parseInt(pageInput.value);
                        if (page >= 1 && page <= paginationState[tabName].totalPages) {
                            changePage(tabName, page);
                        }
                    });
                }
            }

            function changePage(tabName, newPage) {
                if (newPage < 1 || newPage > paginationState[tabName].totalPages) return;
                
                paginationState[tabName].currentPage = newPage;
                updatePaginationInfo(tabName);
                
                // Recarregar a tabela com os dados da p√°gina atual
                if (filteredData) {
                    switch(tabName) {
                        case 'periodo':
                            displayPeriodoTable(filteredData);
                            break;
                        case 'registros':
                            displayRegistrosTable(filteredData);
                            break;
                        case 'itens':
                            displayItensTable(filteredData);
                            break;
                        case 'c170':
                            displayC170Table(filteredData);
                            break;
                        case '0200':
                            display0200Table(filteredData);
                            break;
                        case 'details':
                            displayDetailsTable(filteredData);
                            break;
                        case 'files':
                            displayFilesTable(filteredData);
                            break;
                    }
                }
            }

            function updatePaginationInfo(tabName) {
                const state = paginationState[tabName];
                let pageInfo, pageInput;
                
                if (tabName === '0200') {
                    pageInfo = document.getElementById('pageInfo0200');
                    pageInput = document.getElementById('pageInput0200');
                } else {
                    pageInfo = document.getElementById(`${tabName}PageInfo`);
                    pageInput = document.getElementById(`${tabName}PageInput`);
                }

                if (pageInfo) {
                    pageInfo.textContent = `P√°gina ${state.currentPage} de ${state.totalPages}`;
                }
                if (pageInput) {
                    pageInput.value = state.currentPage;
                }
                
                // Atualizar estado dos bot√µes
                let firstBtn, prevBtn, nextBtn, lastBtn;
                
                if (tabName === '0200') {
                    firstBtn = document.getElementById('first0200');
                    prevBtn = document.getElementById('prev0200');
                    nextBtn = document.getElementById('next0200');
                    lastBtn = document.getElementById('last0200');
                } else {
                    firstBtn = document.getElementById(`${tabName}First`);
                    prevBtn = document.getElementById(`${tabName}Prev`);
                    nextBtn = document.getElementById(`${tabName}Next`);
                    lastBtn = document.getElementById(`${tabName}Last`);
                }

                if (firstBtn) firstBtn.disabled = state.currentPage === 1;
                if (prevBtn) prevBtn.disabled = state.currentPage === 1;
                if (nextBtn) nextBtn.disabled = state.currentPage === state.totalPages;
                if (lastBtn) lastBtn.disabled = state.currentPage === state.totalPages;
            }

            function setupPagination(tabName, dataArray) {
                const state = paginationState[tabName];
                state.totalPages = Math.ceil(dataArray.length / state.pageSize);
                state.currentPage = 1;
                
                let paginationElement;
                if (tabName === '0200') {
                    paginationElement = document.getElementById('pagination0200');
                } else {
                    paginationElement = document.getElementById(`${tabName}Pagination`);
                }
                
                if (paginationElement) {
                    if (state.totalPages > 1) {
                        paginationElement.style.display = 'flex';
                        updatePaginationInfo(tabName);
                    } else {
                        paginationElement.style.display = 'none';
                    }
                }
            }

            function getPaginatedData(tabName, dataArray) {
                const state = paginationState[tabName];
                const start = (state.currentPage - 1) * state.pageSize;
                const end = start + state.pageSize;
                return dataArray.slice(start, end);
            }

            function handleFiles(fileList) {
                performanceWarning.style.display = fileList.length > 50 ? 'block' : 'none';
                
                for (let i = 0; i < fileList.length; i++) {
                    const file = fileList[i];
                    if (!file.type.includes('text/') && !file.name.endsWith('.txt')) {
                        addFileToList(file.name, false, 'Tipo de arquivo n√£o suportado');
                        continue;
                    }
                    if (filesData.some(f => f.name === file.name)) {
                        addFileToList(file.name, false, 'Arquivo duplicado');
                        continue;
                    }
                    addFileToList(file.name, true);
                    filesData.push(file);
                }
                updateFileCount();
                processBtn.disabled = filesData.length === 0;
            }
            
            function addFileToList(fileName, success, errorMessage = '') {
                const fileItem = document.createElement('div');
                fileItem.className = `file-item ${success ? 'success' : 'error'}`;
                fileItem.innerHTML = success ? 
                    `<span>${fileName}</span><span class="status-indicator status-success">‚úì Pronto</span>` :
                    `<span>${fileName}</span><span class="status-indicator status-error">‚úó ${errorMessage}</span>`;
                fileList.appendChild(fileItem);
            }
            
            function updateFileCount() {
                fileCount.textContent = `${filesData.length} arquivo(s)`;
            }
            
            function clearFiles() {
                filesData = [];
                fileList.innerHTML = '';
                updateFileCount();
                processBtn.disabled = true;
                performanceWarning.style.display = 'none';
            }
            
            function processFiles() {
                if (filesData.length === 0) return;
                
                resetAnalysis();
                
                if (filesData.length > 100) {
                    processBatchFiles();
                } else {
                    processNormalFiles();
                }
            }

            async function processBatchFiles() {
                loading.style.display = 'none';
                batchProcessing.style.display = 'block';
                processBtn.disabled = true;
                error.style.display = 'none';
                
                const allResults = {
                    periodos: new Map(),
                    registros: new Map(),
                    filesData: [],
                    totalRegistros: 0,
                    totalValor: 0,
                    recordTypes: new Set()
                };

                const totalBatches = Math.ceil(filesData.length / PERFORMANCE_CONFIG.BATCH_SIZE);
                
                for (let batchIndex = 0; batchIndex < totalBatches; batchIndex++) {
                    const start = batchIndex * PERFORMANCE_CONFIG.BATCH_SIZE;
                    const end = Math.min(start + PERFORMANCE_CONFIG.BATCH_SIZE, filesData.length);
                    const batch = filesData.slice(start, end);
                    
                    const progress = ((batchIndex + 1) / totalBatches) * 100;
                    batchProgressBar.style.width = `${progress}%`;
                    batchProgressText.textContent = `${Math.round(progress)}%`;
                    
                    await processFileBatch(batch, allResults, batchIndex, totalBatches);
                    
                    await new Promise(resolve => setTimeout(resolve, 10));
                }
                
                consolidateResults(allResults);
                displayResults(allResults);
                
                batchProcessing.style.display = 'none';
                processBtn.disabled = false;
            }

            function processNormalFiles() {
                loading.style.display = 'block';
                processBtn.disabled = true;
                error.style.display = 'none';
                
                let processedCount = 0;
                const allResults = {
                    periodos: new Map(),
                    registros: new Map(),
                    filesData: [],
                    totalRegistros: 0,
                    totalValor: 0,
                    recordTypes: new Set()
                };
                
                filesData.forEach((file) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const content = e.target.result;
                            const fileAnalysis = analyzeSpedFile(content, file.name);
                            
                            allResults.filesData.push({
                                fileName: file.name,
                                ...fileAnalysis
                            });
                            
                            processByPeriodo(allResults, fileAnalysis, file.name);
                            
                            processedCount++;
                            if (processedCount === filesData.length) {
                                consolidateResults(allResults);
                                displayResults(allResults);
                                loading.style.display = 'none';
                                processBtn.disabled = false;
                            }
                        } catch (err) {
                            processedCount++;
                            console.error(`Erro ao processar ${file.name}:`, err);
                            showError(`Erro ao processar ${file.name}: ${err.message}`);
                            if (processedCount === filesData.length) {
                                loading.style.display = 'none';
                                processBtn.disabled = false;
                            }
                        }
                    };
                    reader.onerror = () => {
                        processedCount++;
                        showError(`Erro ao ler o arquivo ${file.name}`);
                        if (processedCount === filesData.length) {
                            loading.style.display = 'none';
                            processBtn.disabled = false;
                        }
                    };
                    reader.readAsText(file, 'ISO-8859-1');
                });
            }

            async function processFileBatch(batch, allResults, batchIndex, totalBatches) {
                const promises = batch.map((file, fileIndex) => {
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            try {
                                const content = e.target.result;
                                const fileAnalysis = analyzeSpedFile(content, file.name);
                                
                                allResults.filesData.push({
                                    fileName: file.name,
                                    ...fileAnalysis
                                });
                                
                                processByPeriodo(allResults, fileAnalysis, file.name);
                                
                                // Atualizar arquivo atual
                                const overallIndex = batchIndex * PERFORMANCE_CONFIG.BATCH_SIZE + fileIndex + 1;
                                currentFile.textContent = `Processando: ${file.name} (${overallIndex} de ${filesData.length})`;
                                resolve();
                            } catch (err) {
                                console.error(`Erro ao processar ${file.name}:`, err);
                                currentFile.textContent = `Erro em: ${file.name}`;
                                resolve();
                            }
                        };
                        reader.onerror = () => {
                            console.error(`Erro ao ler o arquivo ${file.name}`);
                            currentFile.textContent = `Erro ao ler: ${file.name}`;
                            resolve();
                        };
                        reader.readAsText(file, 'ISO-8859-1');
                    });
                });
                
                await Promise.all(promises);
            }
            
            function processByPeriodo(allResults, fileAnalysis, fileName) {
                const periodoKey = fileAnalysis.periodo ? 
                    `${fileAnalysis.periodo.ano}-${fileAnalysis.periodo.mes}` : 'sem-periodo';
                
                if (!allResults.periodos.has(periodoKey)) {
                    allResults.periodos.set(periodoKey, {
                        ano: fileAnalysis.periodo?.ano || 'N/A',
                        mes: fileAnalysis.periodo?.mes || 'N/A',
                        descricao: fileAnalysis.periodo ? 
                            `${fileAnalysis.periodo.mes}/${fileAnalysis.periodo.ano}` : 'Sem per√≠odo',
                        arquivos: new Set(),
                        registros: [],
                        items0200: new Map(),
                        registrosC170: [],
                        totalRegistros: 0,
                        totalValor: 0,
                        recordTypes: new Set()
                    });
                }
                
                const periodo = allResults.periodos.get(periodoKey);
                periodo.arquivos.add(fileName);
                
                fileAnalysis.allRecords.forEach(record => {
                    periodo.registros.push(record);
                    periodo.totalRegistros++;
                    periodo.totalValor += record.valor;
                    periodo.recordTypes.add(record.registro);
                    
                    allResults.totalRegistros++;
                    allResults.totalValor += record.valor;
                    allResults.recordTypes.add(record.registro);
                    
                    if (!allResults.registros.has(record.registro)) {
                        allResults.registros.set(record.registro, {
                            registro: record.registro,
                            count: 0,
                            total: 0,
                            periodos: new Set(),
                            arquivos: new Set()
                        });
                    }
                    const registroData = allResults.registros.get(record.registro);
                    registroData.count++;
                    registroData.total += record.valor;
                    registroData.periodos.add(periodoKey);
                    registroData.arquivos.add(fileName);
                });
                
                fileAnalysis.items0200.forEach((item, codigo) => {
                    periodo.items0200.set(codigo, item);
                });
                
                periodo.registrosC170.push(...fileAnalysis.registrosC170);
            }

            // FUN√á√ÉO MELHORADA PARA PARSE DE VALORES DO SPED
            function parseValorSPED(valorStr) {
                if (!valorStr || valorStr === '' || valorStr === undefined) return 0;
                
                valorStr = valorStr.trim();
                if (valorStr === '') return 0;
                
                try {
                    // Remover qualquer caractere que n√£o seja n√∫mero, ponto ou v√≠rgula
                    let valorLimpo = valorStr.replace(/[^\d,.-]/g, '');
                    
                    // Se n√£o h√° separadores decimais, tratar como inteiro
                    if (!valorLimpo.includes(',') && !valorLimpo.includes('.')) {
                        return parseFloat(valorLimpo) || 0;
                    }
                    
                    // Tratamento para formato brasileiro: 1.234,56
                    if (valorLimpo.includes(',') && valorLimpo.lastIndexOf(',') > valorLimpo.lastIndexOf('.')) {
                        // Remover pontos dos milhares e substituir v√≠rgula decimal por ponto
                        valorLimpo = valorLimpo.replace(/\./g, '').replace(',', '.');
                    }
                    // Tratamento para formato internacional: 1,234.56
                    else if (valorLimpo.includes('.') && valorLimpo.lastIndexOf('.') > valorLimpo.lastIndexOf(',')) {
                        // Remover v√≠rgulas dos milhares
                        valorLimpo = valorLimpo.replace(/,/g, '');
                    }
                    
                    const valorNumerico = parseFloat(valorLimpo);
                    
                    // Valida√ß√£o rigorosa
                    if (isNaN(valorNumerico)) {
                        console.warn('Valor n√£o p√¥de ser parseado:', valorStr, '->', valorLimpo);
                        return 0;
                    }
                    
                    // Verificar se o valor √© realistico (menos de 1 bilh√£o)
                    if (Math.abs(valorNumerico) > 1000000000) {
                        console.warn('Valor potencialmente errado:', valorStr, '->', valorNumerico);
                        // Para valores muito grandes, tentar dividir por 100 (poss√≠vel erro de casas decimais)
                        const valorCorrigido = valorNumerico / 100;
                        if (Math.abs(valorCorrigido) < 1000000000) {
                            return valorCorrigido;
                        }
                        return 0;
                    }
                    
                    return valorNumerico;
                    
                } catch (error) {
                    console.error('Erro ao parsear valor:', valorStr, error);
                    return 0;
                }
            }

            // FUN√á√ÉO CORRIGIDA PARA EXTRAIR VALORES DOS REGISTROS
            function extractValorFromRegistro(registro, parts) {
                let valor = 0;
                
                const camposValor = {
                    'C100': 10,    // VL_PIS em C100
                    'C170': 6,     // VL_ITEM em C170
                    'C190': 5,     // VL_OPR em C190
                    'C191': 3,     // VL_BC_ICMS em C191
                    'C195': 3,     // VL_BC_ICMS em C195
                    'C197': 3,     // VL_BC_ICMS em C197
                    'C500': 5,     // VL_DOC em C500
                    'C590': 5,     // VL_BC_ICMS em C590
                    'D100': 7,     // VL_DOC em D100 - CORRIGIDO
                    'D190': 5,     // VL_BC_ICMS em D190
                    'D500': 5,     // VL_DOC em D500
                    'D590': 5,     // VL_BC_ICMS em D590
                    'E110': 2,     // VL_TOT_DEBITOS em E110
                    'E116': 3,     // VL_OUT_DEB em E116
                    'E210': 2,     // VL_TOT_DEBITOS em E210
                    'E310': 2      // VL_TOT_DEBITOS em E310
                };
                
                // Tratamento espec√≠fico para D100
                if (registro === 'D100' && parts.length > 7) {
                    const campoValor = parts[7]; // Campo 8 (√≠ndice 7) √© VL_DOC no D100
                    if (campoValor && campoValor.trim() !== '') {
                        valor = parseValorSPED(campoValor);
                        if (debugMode) {
                            console.log('D100 - Campo valor:', campoValor, 'Valor parseado:', valor);
                        }
                    }
                }
                else if (camposValor[registro] !== undefined && parts.length > camposValor[registro]) {
                    const campoValor = parts[camposValor[registro]];
                    if (campoValor && campoValor.trim() !== '') {
                        valor = parseValorSPED(campoValor);
                    }
                } else {
                    // Fallback: procurar por campos num√©ricos
                    for (let i = 1; i < parts.length; i++) {
                        const part = parts[i];
                        if (part && part.trim() !== '') {
                            if (part.includes(',') || (!isNaN(part) && part.includes('.')) || 
                                (part.replace(',', '.').replace(/[^0-9.-]/g, '') !== '')) {
                                
                                const potentialValor = parseValorSPED(part);
                                // Valida√ß√£o mais rigorosa para evitar valores absurdos
                                if (potentialValor !== 0 && Math.abs(potentialValor) < 1000000000) { // Limite de 1 bilh√£o
                                    valor = potentialValor;
                                    break;
                                }
                            }
                        }
                    }
                }
                
                // Valida√ß√£o final do valor
                if (!isFinite(valor) || Math.abs(valor) > 1e12) {
                    if (debugMode) {
                        console.warn(`Valor inv√°lido detectado no registro ${registro}:`, valor, 'Parts:', parts);
                    }
                    valor = 0;
                }
                
                if (debugMode && valor !== 0) {
                    console.log(`Registro ${registro}: valor encontrado =`, valor, 'parts:', parts);
                }
                
                return valor;
            }
            
            function isRegistroComValor(registro) {
                const registrosComValor = [
                    'C100', 'C101', 'C105', 'C110', 'C111', 'C112', 'C113', 'C114', 'C115', 'C116', 'C120', 
                    'C130', 'C140', 'C141', 'C160', 'C165', 'C170', 'C171', 'C172', 'C173', 'C174', 'C175', 
                    'C176', 'C177', 'C178', 'C179', 'C190', 'C191', 'C195', 'C197', 'C300', 'C310', 'C320', 
                    'C321', 'C350', 'C370', 'C390', 'C400', 'C405', 'C410', 'C420', 'C425', 'C430', 'C440', 
                    'C460', 'C470', 'C490', 'C500', 'C510', 'C590', 'C600', 'C601', 'C610', 'C690', 'C700', 
                    'C790', 'C791', 'C800', 'C850', 'C860', 'C890', 'C895', 'D100', 'D101', 'D105', 'D110', 
                    'D111', 'D112', 'D113', 'D114', 'D115', 'D116', 'D120', 'D130', 'D140', 'D150', 'D190', 
                    'D195', 'D197', 'D300', 'D301', 'D310', 'D350', 'D355', 'D360', 'D365', 'D370', 'D390', 
                    'D400', 'D410', 'D411', 'D420', 'D500', 'D510', 'D590', 'D600', 'D610', 'D690', 'D695', 
                    'D696', 'D697', 'E100', 'E110', 'E111', 'E112', 'E113', 'E115', 'E116', 'E200', 'E210', 
                    'E220', 'E230', 'E240', 'E250', 'E500', 'E510', 'E520', 'E530', 'E990'
                ];
                
                return registrosComValor.includes(registro) || 
                       registro.startsWith('C') || 
                       registro.startsWith('D') || 
                       registro.startsWith('E');
            }
            
            function extractDataFromRegistro(registro, parts) {
                switch (registro) {
                    case 'C100': 
                        if (parts.length > 8 && parts[8] && parts[8].length === 8) {
                            const data = parts[8];
                            return `${data.substring(0,2)}/${data.substring(2,4)}/${data.substring(4,8)}`;
                        }
                        return '';
                    case 'D100': 
                        if (parts.length > 6 && parts[6] && parts[6].length === 8) {
                            const data = parts[6];
                            return `${data.substring(0,2)}/${data.substring(2,4)}/${data.substring(4,8)}`;
                        }
                        return '';
                    default: 
                        return '';
                }
            }
            
            function analyzeSpedFile(content, fileName) {
                const lines = content.split('\n');
                let periodo = null;
                let allRecords = [];
                const items0200 = new Map();
                const registrosC170 = [];
                
                console.log(`Analisando arquivo: ${fileName} com ${lines.length} linhas`);
                
                for (const line of lines) {
                    if (!line.trim()) continue;
                    
                    const parts = line.split('|').filter(part => part !== '');
                    if (parts.length < 2) continue;
                    
                    const registro = parts[0];
                    
                    if (registro === '0000' && parts.length >= 5) {
                        const dataInicio = parts[3];
                        if (dataInicio && dataInicio.length === 8) {
                            periodo = {
                                dataInicio: `${dataInicio.substring(0,2)}/${dataInicio.substring(2,4)}/${dataInicio.substring(4,8)}`,
                                dataFim: `${parts[4].substring(0,2)}/${parts[4].substring(2,4)}/${parts[4].substring(4,8)}`,
                                mes: dataInicio.substring(2,4),
                                ano: dataInicio.substring(4,8)
                            };
                        }
                    }
                    else if (registro === '0200' && parts.length >= 3) {
                        const itemData = {
                            arquivo: fileName,
                            periodo: periodo,
                            codigo: parts[1],
                            descricao: parts[2],
                            codBarras: parts[3] || '',
                            unidade: parts[5] || '',
                            tipoItem: parts[6] || '',
                            codNCM: parts[7] || ''
                        };
                        items0200.set(parts[1], itemData);
                        
                        allRecords.push({
                            fileName,
                            registro: '0200',
                            itemCodigo: parts[1],
                            itemDescricao: parts[2],
                            valor: 0,
                            data: '',
                            linha: line,
                            periodo: periodo
                        });
                    }
                    else if (registro === 'C170' && parts.length >= 8) {
                        const c170Data = {
                            arquivo: fileName,
                            periodo: periodo,
                            numItem: parts[1] || '',
                            codItem: parts[2] || '',
                            descricaoCompl: parts[3] || '',
                            qtd: parseValorSPED(parts[4]),
                            unid: parts[5] || '',
                            vlItem: parseValorSPED(parts[6]),
                            vlDesc: parseValorSPED(parts[7]),
                            vlBaseICMS: parseValorSPED(parts[12]),
                            vlICMS: parseValorSPED(parts[14])
                        };
                        registrosC170.push(c170Data);
                        
                        allRecords.push({
                            fileName,
                            registro: 'C170',
                            itemCodigo: parts[2],
                            itemDescricao: '',
                            valor: c170Data.vlItem,
                            data: '',
                            linha: line,
                            periodo: periodo
                        });
                    }
                    else if (isRegistroComValor(registro)) {
                        const valor = extractValorFromRegistro(registro, parts);
                        const recordData = {
                            fileName,
                            registro,
                            itemCodigo: '',
                            itemDescricao: '',
                            valor: valor,
                            data: extractDataFromRegistro(registro, parts),
                            linha: line,
                            periodo: periodo
                        };
                        
                        if (valor > 1000000000) {
                            console.warn(`Valor potencialmente errado no registro ${registro}:`, valor, 'Line:', line);
                        }
                        
                        allRecords.push(recordData);
                    }
                }
                
                console.log(`Arquivo ${fileName} processado: ${allRecords.length} registros, ${items0200.size} itens 0200, ${registrosC170.length} registros C170`);
                
                return {
                    periodo,
                    allRecords,
                    items0200,
                    registrosC170,
                    totalRegistros: allRecords.length,
                    totalValor: allRecords.reduce((sum, record) => sum + record.valor, 0)
                };
            }

            function validarValores(data) {
                let valoresInvalidos = 0;
                let totalValor = 0;
                
                data.periodos.forEach((periodo, periodoKey) => {
                    periodo.registros.forEach(record => {
                        // Valida√ß√£o mais rigorosa
                        if (!isFinite(record.valor) || 
                            record.valor > 1e12 || 
                            record.valor < -1e12 ||
                            (record.registro === 'D100' && record.valor > 1000000000)) {
                            
                            console.warn(`Valor inv√°lido encontrado:`, {
                                periodo: periodoKey,
                                registro: record.registro,
                                valor: record.valor,
                                arquivo: record.fileName
                            });
                            valoresInvalidos++;
                            record.valor = 0;
                        } else {
                            totalValor += record.valor;
                        }
                    });
                });
                
                if (valoresInvalidos > 0) {
                    console.log(`Corrigidos ${valoresInvalidos} valores inv√°lidos`);
                }
                
                return totalValor;
            }

            function consolidateResults(allResults) {
                const totalValorValido = validarValores(allResults);
                allResults.totalValor = totalValorValido;
                
                allResults.periodos.forEach((periodo, periodoKey) => {
                    const itemsComValores = new Map();
                    
                    periodo.registrosC170.forEach(c170 => {
                        if (c170.codItem) {
                            const item0200 = periodo.items0200.get(c170.codItem);
                            const itemKey = `${c170.codItem}|${periodoKey}`;
                            
                            if (!itemsComValores.has(itemKey)) {
                                itemsComValores.set(itemKey, {
                                    codigo: c170.codItem,
                                    descricao: item0200 ? item0200.descricao : 'N√£o cadastrado',
                                    unidade: item0200 ? item0200.unidade : c170.unid,
                                    periodo: periodo.descricao,
                                    quantidadeTotal: 0,
                                    valorTotal: 0,
                                    registrosC170: [],
                                    arquivos: new Set()
                                });
                            }
                            
                            const item = itemsComValores.get(itemKey);
                            item.quantidadeTotal += c170.qtd;
                            item.valorTotal += c170.vlItem;
                            item.registrosC170.push(c170);
                            item.arquivos.add(c170.arquivo);
                        }
                    });
                    
                    periodo.itemsComValores = itemsComValores;
                    periodo.totalValor = periodo.registros.reduce((sum, record) => sum + record.valor, 0);
                });
                
                analysisData = allResults;
                filteredData = JSON.parse(JSON.stringify(allResults));
                
                console.log('Consolida√ß√£o finalizada. Total valor:', allResults.totalValor);
            }

            function displayResults(data) {
                processedFiles.textContent = data.filesData.length;
                totalPeriodos.textContent = data.periodos.size;
                totalRegistros.textContent = data.totalRegistros;
                totalValue.textContent = `R$ ${data.totalValor.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                
                updateFilters(data);
                updateDebugInfo(data);
                
                // Verificar se precisa ativar pagina√ß√£o
                const totalRecords = data.totalRegistros;
                if (totalRecords > PERFORMANCE_CONFIG.VIRTUAL_SCROLL_THRESHOLD) {
                    Object.keys(paginationState).forEach(tab => {
                        paginationState[tab].pageSize = PERFORMANCE_CONFIG.PAGE_SIZE;
                    });
                }
                
                displayPeriodoTable(data);
                displayRegistrosTable(data);
                displayItensTable(data);
                displayC170Table(data);
                display0200Table(data);
                displayDetailsTable(data);
                displayFilesTable(data);
                
                resultsSection.style.display = 'block';
            }
            
            function displayPeriodoTable(data) {
                const periodosArray = Array.from(data.periodos.values()).sort((a, b) => {
                    if (a.ano === 'N/A') return 1;
                    if (b.ano === 'N/A') return -1;
                    return `${a.ano}${a.mes}`.localeCompare(`${b.ano}${b.mes}`);
                });
                
                setupPagination('periodo', periodosArray);
                const paginatedData = getPaginatedData('periodo', periodosArray);
                
                periodoTableBody.innerHTML = '';
                let globalTotal = 0;
                
                paginatedData.forEach(periodo => {
                    const totalC170 = periodo.registrosC170.reduce((sum, c170) => sum + c170.vlItem, 0);
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><span class="periodo-badge">${periodo.descricao}</span></td>
                        <td>${periodo.arquivos.size}</td>
                        <td>${periodo.totalRegistros}</td>
                        <td>${Array.from(periodo.recordTypes).sort().join(', ')}</td>
                        <td class="valor-cell">R$ ${periodo.totalValor.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td>${periodo.items0200.size}</td>
                        <td>${periodo.registrosC170.length}</td>
                        <td class="valor-cell">R$ ${totalC170.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    `;
                    periodoTableBody.appendChild(row);
                    globalTotal += periodo.totalValor;
                });
                
                // Mostrar total geral apenas na √∫ltima p√°gina
                if (paginationState.periodo.currentPage === paginationState.periodo.totalPages || paginationState.periodo.totalPages === 1) {
                    const totalRow = document.createElement('tr');
                    totalRow.className = 'total-row';
                    totalRow.innerHTML = `
                        <td><strong>TOTAL GERAL</strong></td>
                        <td>${data.filesData.length}</td>
                        <td>${data.totalRegistros}</td>
                        <td>${data.recordTypes.size} tipos</td>
                        <td class="valor-cell"><strong>R$ ${globalTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong></td>
                        <td>${Array.from(data.periodos.values()).reduce((sum, p) => sum + p.items0200.size, 0)}</td>
                        <td>${Array.from(data.periodos.values()).reduce((sum, p) => sum + p.registrosC170.length, 0)}</td>
                        <td class="valor-cell"><strong>R$ ${Array.from(data.periodos.values()).reduce((sum, p) => sum + p.registrosC170.reduce((s, c) => s + c.vlItem, 0), 0).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong></td>
                    `;
                    periodoTableBody.appendChild(totalRow);
                }
            }
            
            function displayRegistrosTable(data) {
                const registrosArray = Array.from(data.registros.values()).sort((a, b) => b.total - a.total);
                setupPagination('registros', registrosArray);
                const paginatedData = getPaginatedData('registros', registrosArray);
                
                registrosTableBody.innerHTML = '';
                
                paginatedData.forEach(registro => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><span class="registro-badge">${registro.registro}</span></td>
                        <td>${getRegistroDescription(registro.registro)}</td>
                        <td>${registro.count}</td>
                        <td class="valor-cell">R$ ${registro.total.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td>${registro.periodos.size}</td>
                        <td>${registro.arquivos.size}</td>
                    `;
                    registrosTableBody.appendChild(row);
                });
            }
            
            function displayItensTable(data) {
                const itensArray = [];
                Array.from(data.periodos.values()).forEach(periodo => {
                    periodo.itemsComValores.forEach(item => {
                        itensArray.push(item);
                    });
                });
                
                setupPagination('itens', itensArray);
                const paginatedData = getPaginatedData('itens', itensArray);
                
                itensTableBody.innerHTML = '';
                
                paginatedData.forEach(item => {
                    const valorUnitarioMedio = item.quantidadeTotal > 0 ? item.valorTotal / item.quantidadeTotal : 0;
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>${item.codigo}</strong></td>
                        <td>${item.descricao}</td>
                        <td>${item.unidade}</td>
                        <td class="periodo-column"><span class="periodo-badge">${item.periodo}</span></td>
                        <td>${item.quantidadeTotal.toLocaleString('pt-BR', {minimumFractionDigits: 3, maximumFractionDigits: 3})}</td>
                        <td class="valor-cell">R$ ${item.valorTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td>R$ ${valorUnitarioMedio.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td>${item.registrosC170.length}</td>
                        <td>${Array.from(item.arquivos).join(', ')}</td>
                    `;
                    itensTableBody.appendChild(row);
                });
            }
            
            function displayC170Table(data) {
                const c170Array = [];
                Array.from(data.periodos.values()).forEach(periodo => {
                    periodo.registrosC170.forEach(c170 => {
                        c170Array.push({...c170, periodoDesc: periodo.descricao});
                    });
                });
                
                setupPagination('c170', c170Array);
                const paginatedData = getPaginatedData('c170', c170Array);
                
                c170TableBody.innerHTML = '';
                
                paginatedData.forEach(c170 => {
                    const periodo = Array.from(data.periodos.values()).find(p => p.descricao === c170.periodoDesc);
                    const item0200 = periodo ? periodo.items0200.get(c170.codItem) : null;
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="periodo-column"><span class="periodo-badge">${c170.periodoDesc}</span></td>
                        <td>${c170.arquivo}</td>
                        <td><strong>${c170.codItem}</strong></td>
                        <td>${item0200?.descricao || ''}</td>
                        <td>${c170.descricaoCompl}</td>
                        <td>${c170.qtd.toLocaleString('pt-BR', {minimumFractionDigits: 3, maximumFractionDigits: 3})}</td>
                        <td>${c170.unid}</td>
                        <td class="valor-cell">R$ ${c170.vlItem.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td>R$ ${c170.vlDesc.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td>R$ ${c170.vlBaseICMS.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td>R$ ${c170.vlICMS.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    `;
                    c170TableBody.appendChild(row);
                });
            }
            
            function display0200Table(data) {
                const items0200Array = [];
                Array.from(data.periodos.values()).forEach(periodo => {
                    periodo.items0200.forEach(item => {
                        items0200Array.push({...item, periodoDesc: periodo.descricao});
                    });
                });
                
                setupPagination('0200', items0200Array);
                const paginatedData = getPaginatedData('0200', items0200Array);
                
                table0200Body.innerHTML = '';
                
                paginatedData.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="periodo-column"><span class="periodo-badge">${item.periodoDesc}</span></td>
                        <td>${item.arquivo}</td>
                        <td><strong>${item.codigo}</strong></td>
                        <td>${item.descricao}</td>
                        <td>${item.codBarras}</td>
                        <td>${item.unidade}</td>
                        <td>${getTipoItemDescription(item.tipoItem)}</td>
                        <td>${item.codNCM}</td>
                    `;
                    table0200Body.appendChild(row);
                });
            }
            
            function displayDetailsTable(data) {
                const detailsArray = [];
                Array.from(data.periodos.values()).forEach(periodo => {
                    periodo.registros.forEach(record => {
                        detailsArray.push({...record, periodoDesc: periodo.descricao});
                    });
                });
                
                setupPagination('details', detailsArray);
                const paginatedData = getPaginatedData('details', detailsArray);
                
                detailsTableBody.innerHTML = '';
                
                paginatedData.forEach(record => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="periodo-column"><span class="periodo-badge">${record.periodoDesc}</span></td>
                        <td>${record.fileName}</td>
                        <td><span class="registro-badge">${record.registro}</span></td>
                        <td>${record.itemCodigo}</td>
                        <td>${record.itemDescricao}</td>
                        <td class="valor-cell">R$ ${record.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td>${record.data}</td>
                        <td><small>${record.linha.substring(0, 100)}...</small></td>
                    `;
                    detailsTableBody.appendChild(row);
                });
            }
            
            function displayFilesTable(data) {
                const filesArray = data.filesData;
                setupPagination('files', filesArray);
                const paginatedData = getPaginatedData('files', filesArray);
                
                filesTableBody.innerHTML = '';
                
                paginatedData.forEach(file => {
                    const periodo = file.periodo;
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${file.fileName}</td>
                        <td>${periodo ? `${periodo.dataInicio} a ${periodo.dataFim}` : 'N√£o identificado'}</td>
                        <td>${periodo ? `${periodo.mes}/${periodo.ano}` : 'N/A'}</td>
                        <td>${file.totalRegistros}</td>
                        <td>${Array.from(new Set(file.allRecords.map(r => r.registro))).join(', ')}</td>
                        <td class="valor-cell">R$ ${file.totalValor.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td>${file.items0200.size}</td>
                        <td>${file.registrosC170.length}</td>
                    `;
                    filesTableBody.appendChild(row);
                });
            }
            
            function updateFilters(data) {
                const anos = new Set();
                data.periodos.forEach(periodo => {
                    if (periodo.ano !== 'N/A') anos.add(periodo.ano);
                });
                
                filterAno.innerHTML = '<option value="">Todos os anos</option>';
                Array.from(anos).sort().reverse().forEach(ano => {
                    const option = document.createElement('option');
                    option.value = ano;
                    option.textContent = ano;
                    filterAno.appendChild(option);
                });
                
                filterRegistro.innerHTML = '<option value="">Todos os registros</option>';
                Array.from(data.recordTypes).sort().forEach(registro => {
                    const option = document.createElement('option');
                    option.value = registro;
                    option.textContent = `${registro} - ${getRegistroDescription(registro)}`;
                    filterRegistro.appendChild(option);
                });
            }
            
            // FUN√á√ÉO IMPLEMENTADA: Aplicar Filtros
            function applyFilters() {
                if (!analysisData) return;
                
                console.log('Aplicando filtros...');
                
                // Criar c√≥pia dos dados para filtragem
                filteredData = JSON.parse(JSON.stringify(analysisData));
                
                // Aplicar filtros
                const anoFiltro = filterAno.value;
                const mesFiltro = filterMes.value;
                const registroFiltro = filterRegistro.value;
                const itemCodigoFiltro = filterItemCodigo.value.trim().toUpperCase();
                const itemDescricaoFiltro = filterItemDescricao.value.trim().toLowerCase();
                const valorMinFiltro = parseFloat(filterValorMin.value) || 0;
                const valorMaxFiltro = parseFloat(filterValorMax.value) || Infinity;
                const unidadeFiltro = filterUnidade.value.trim().toUpperCase();
                
                // Filtrar per√≠odos
                filteredData.periodos.forEach((periodo, periodoKey) => {
                    if (anoFiltro && periodo.ano !== anoFiltro) {
                        filteredData.periodos.delete(periodoKey);
                        return;
                    }
                    
                    if (mesFiltro && periodo.mes !== mesFiltro) {
                        filteredData.periodos.delete(periodoKey);
                        return;
                    }
                    
                    // Filtrar registros dentro do per√≠odo
                    periodo.registros = periodo.registros.filter(record => {
                        if (registroFiltro && record.registro !== registroFiltro) return false;
                        if (itemCodigoFiltro && record.itemCodigo !== itemCodigoFiltro) return false;
                        if (itemDescricaoFiltro && !record.itemDescricao.toLowerCase().includes(itemDescricaoFiltro)) return false;
                        if (record.valor < valorMinFiltro || record.valor > valorMaxFiltro) return false;
                        return true;
                    });
                    
                    // Filtrar itens 0200
                    periodo.items0200.forEach((item, codigo) => {
                        if (unidadeFiltro && item.unidade !== unidadeFiltro) {
                            periodo.items0200.delete(codigo);
                        }
                    });
                    
                    // Filtrar registros C170
                    periodo.registrosC170 = periodo.registrosC170.filter(c170 => {
                        if (itemCodigoFiltro && c170.codItem !== itemCodigoFiltro) return false;
                        if (unidadeFiltro && c170.unid !== unidadeFiltro) return false;
                        if (c170.vlItem < valorMinFiltro || c170.vlItem > valorMaxFiltro) return false;
                        return true;
                    });
                    
                    // Recalcular totais do per√≠odo
                    periodo.totalRegistros = periodo.registros.length;
                    periodo.totalValor = periodo.registros.reduce((sum, record) => sum + record.valor, 0);
                    periodo.recordTypes = new Set(periodo.registros.map(r => r.registro));
                });
                
                // Recalcular totais gerais
                filteredData.totalRegistros = Array.from(filteredData.periodos.values())
                    .reduce((sum, periodo) => sum + periodo.totalRegistros, 0);
                filteredData.totalValor = Array.from(filteredData.periodos.values())
                    .reduce((sum, periodo) => sum + periodo.totalValor, 0);
                
                // Atualizar exibi√ß√£o
                displayResults(filteredData);
                
                console.log('Filtros aplicados com sucesso');
            }
            
            // FUN√á√ÉO IMPLEMENTADA: Limpar Filtros
            function clearFilters() {
                filterAno.value = '';
                filterMes.value = '';
                filterRegistro.value = '';
                filterItemCodigo.value = '';
                filterItemDescricao.value = '';
                filterValorMin.value = '';
                filterValorMax.value = '';
                filterUnidade.value = '';
                
                if (analysisData) {
                    filteredData = JSON.parse(JSON.stringify(analysisData));
                    displayResults(filteredData);
                }
                
                console.log('Filtros limpos');
            }
            
            // FUN√á√ÉO IMPLEMENTADA: Validar Filtros de Valor
            function validateValorFilters() {
                const valorMin = parseFloat(filterValorMin.value);
                const valorMax = parseFloat(filterValorMax.value);
                
                if (valorMin > 0 && valorMax > 0 && valorMin > valorMax) {
                    filterValorMin.setCustomValidity('Valor m√≠nimo n√£o pode ser maior que o m√°ximo');
                    filterValorMin.style.borderColor = 'var(--accent-color)';
                    filterValorMax.style.borderColor = 'var(--accent-color)';
                } else {
                    filterValorMin.setCustomValidity('');
                    filterValorMin.style.borderColor = '';
                    filterValorMax.style.borderColor = '';
                }
            }
            
            // FUN√á√ÉO IMPLEMENTADA: Alternar Vista Per√≠odo/Consolidada
            function togglePeriodoViewHandler() {
                periodoView = !periodoView;
                togglePeriodoView.textContent = periodoView ? 'Vista Consolidada' : 'Vista por Per√≠odo';
                
                // Aplicar/remover classe para ocultar colunas de per√≠odo
                const tables = document.querySelectorAll('#itensTab, #c170Tab, #tab0200, #detailsTab');
                tables.forEach(table => {
                    if (periodoView) {
                        table.classList.remove('view-consolidada');
                    } else {
                        table.classList.add('view-consolidada');
                    }
                });
                
                // Se h√° dados filtrados, reexibir para aplicar a mudan√ßa de visualiza√ß√£o
                if (filteredData) {
                    displayItensTable(filteredData);
                    displayC170Table(filteredData);
                    display0200Table(filteredData);
                    displayDetailsTable(filteredData);
                }
                
                console.log(`Vista alterada para: ${periodoView ? 'Por Per√≠odo' : 'Consolidada'}`);
            }
            
            // FUN√á√ÉO IMPLEMENTADA: Atualizar Informa√ß√µes de Debug
            function updateDebugInfo(data) {
                if (!debugMode) return;
                
                let debugHTML = `
                    <div><strong>Arquivos Processados:</strong> ${data.filesData.length}</div>
                    <div><strong>Per√≠odos Encontrados:</strong> ${data.periodos.size}</div>
                    <div><strong>Total de Registros:</strong> ${data.totalRegistros}</div>
                    <div><strong>Valor Total:</strong> R$ ${data.totalValor.toLocaleString('pt-BR')}</div>
                    <div><strong>Tipos de Registro:</strong> ${Array.from(data.recordTypes).sort().join(', ')}</div>
                    <br>
                    <div><strong>Detalhes por Per√≠odo:</strong></div>
                `;
                
                Array.from(data.periodos.values()).sort((a, b) => `${a.ano}${a.mes}`.localeCompare(`${b.ano}${b.mes}`)).forEach(periodo => {
                    debugHTML += `
                        <div style="margin-left: 20px;">
                            <strong>${periodo.descricao}:</strong> 
                            ${periodo.registros.length} registros, 
                            R$ ${periodo.totalValor.toLocaleString('pt-BR')}, 
                            ${periodo.arquivos.size} arquivos
                        </div>
                    `;
                });
                
                debugContent.innerHTML = debugHTML;
            }
            
            // FUN√á√ÉO IMPLEMENTADA: Toggle Debug
            function toggleDebug() {
                debugMode = !debugMode;
                debugInfo.style.display = debugMode ? 'block' : 'none';
                debugToggle.textContent = debugMode ? 'Ocultar Debug' : 'Mostrar Debug';
                
                if (debugMode && filteredData) {
                    updateDebugInfo(filteredData);
                }
            }
            
            function exportToExcel() {
                if (!analysisData) {
                    showError('Nenhum dado para exportar. Processe os arquivos primeiro.');
                    return;
                }

                try {
                    loading.style.display = 'block';
                    
                    setTimeout(() => {
                        const wb = XLSX.utils.book_new();
                        
                        // Aba: Resumo por Per√≠odo
                        const periodoData = [
                            ['Per√≠odo', 'Arquivos', 'Total de Registros', 'Tipos de Registros', 'Valor Total', 'Itens Cadastrados', 'Registros C170', 'Valor C170']
                        ];
                        
                        Array.from(analysisData.periodos.values()).sort((a, b) => {
                            if (a.ano === 'N/A') return 1;
                            if (b.ano === 'N/A') return -1;
                            return `${a.ano}${a.mes}`.localeCompare(`${b.ano}${b.mes}`);
                        }).forEach(periodo => {
                            const totalC170 = periodo.registrosC170.reduce((sum, c170) => sum + c170.vlItem, 0);
                            periodoData.push([
                                periodo.descricao,
                                periodo.arquivos.size,
                                periodo.totalRegistros,
                                Array.from(periodo.recordTypes).sort().join(', '),
                                periodo.totalValor,
                                periodo.items0200.size,
                                periodo.registrosC170.length,
                                totalC170
                            ]);
                        });
                        
                        const wsPeriodo = XLSX.utils.aoa_to_sheet(periodoData);
                        XLSX.utils.book_append_sheet(wb, wsPeriodo, 'Resumo por Per√≠odo');
                        
                        // Aba: Totais por Registro
                        const registrosData = [
                            ['Tipo de Registro', 'Descri√ß√£o', 'Quantidade Total', 'Valor Total', 'Per√≠odos', 'Arquivos']
                        ];
                        
                        Array.from(analysisData.registros.values()).sort((a, b) => b.total - a.total).forEach(registro => {
                            registrosData.push([
                                registro.registro,
                                getRegistroDescription(registro.registro),
                                registro.count,
                                registro.total,
                                registro.periodos.size,
                                registro.arquivos.size
                            ]);
                        });
                        
                        const wsRegistros = XLSX.utils.aoa_to_sheet(registrosData);
                        XLSX.utils.book_append_sheet(wb, wsRegistros, 'Totais por Registro');
                        
                        // Aba: Itens com Valores
                        const itensData = [
                            ['C√≥digo', 'Descri√ß√£o', 'Unidade', 'Per√≠odo', 'Quantidade Total', 'Valor Total', 'Valor Unit√°rio M√©dio', 'Qtde. C170', 'Arquivos']
                        ];
                        
                        Array.from(analysisData.periodos.values()).forEach(periodo => {
                            periodo.itemsComValores.forEach(item => {
                                const valorUnitarioMedio = item.quantidadeTotal > 0 ? item.valorTotal / item.quantidadeTotal : 0;
                                itensData.push([
                                    item.codigo,
                                    item.descricao,
                                    item.unidade,
                                    item.periodo,
                                    item.quantidadeTotal,
                                    item.valorTotal,
                                    valorUnitarioMedio,
                                    item.registrosC170.length,
                                    Array.from(item.arquivos).join(', ')
                                ]);
                            });
                        });
                        
                        const wsItens = XLSX.utils.aoa_to_sheet(itensData);
                        XLSX.utils.book_append_sheet(wb, wsItens, 'Itens com Valores');
                        
                        // Aba: Registros C170
                        const c170Data = [
                            ['Per√≠odo', 'Arquivo', 'C√≥digo Item', 'Descri√ß√£o Item', 'Descri√ß√£o Complementar', 'Quantidade', 'Unidade', 'Valor Item', 'Valor Desconto', 'Base ICMS', 'Valor ICMS']
                        ];
                        
                        Array.from(analysisData.periodos.values()).forEach(periodo => {
                            periodo.registrosC170.forEach(c170 => {
                                const item0200 = periodo.items0200.get(c170.codItem);
                                c170Data.push([
                                    periodo.descricao,
                                    c170.arquivo,
                                    c170.codItem,
                                    item0200?.descricao || '',
                                    c170.descricaoCompl,
                                    c170.qtd,
                                    c170.unid,
                                    c170.vlItem,
                                    c170.vlDesc,
                                    c170.vlBaseICMS,
                                    c170.vlICMS
                                ]);
                            });
                        });
                        
                        const wsC170 = XLSX.utils.aoa_to_sheet(c170Data);
                        XLSX.utils.book_append_sheet(wb, wsC170, 'Registros C170');
                        
                        // Aba: Cadastro de Itens
                        const registro0200Data = [
                            ['Per√≠odo', 'Arquivo', 'C√≥digo Item', 'Descri√ß√£o', 'C√≥digo Barras', 'Unidade', 'Tipo Item', 'C√≥digo NCM']
                        ];
                        
                        Array.from(analysisData.periodos.values()).forEach(periodo => {
                            periodo.items0200.forEach(item => {
                                registro0200Data.push([
                                    periodo.descricao,
                                    item.arquivo,
                                    item.codigo,
                                    item.descricao,
                                    item.codBarras,
                                    item.unidade,
                                    getTipoItemDescription(item.tipoItem),
                                    item.codNCM
                                ]);
                            });
                        });
                        
                        const ws0200 = XLSX.utils.aoa_to_sheet(registro0200Data);
                        XLSX.utils.book_append_sheet(wb, ws0200, 'Cadastro de Itens');
                        
                        // Aba: Todos os Registros Detalhados
                        const detailsData = [
                            ['Per√≠odo', 'Arquivo', 'Registro', 'Item C√≥digo', 'Item Descri√ß√£o', 'Valor', 'Data', 'Linha Completa']
                        ];
                        
                        Array.from(analysisData.periodos.values()).forEach(periodo => {
                            periodo.registros.forEach(record => {
                                detailsData.push([
                                    periodo.descricao,
                                    record.fileName,
                                    record.registro,
                                    record.itemCodigo,
                                    record.itemDescricao,
                                    record.valor,
                                    record.data,
                                    record.linha
                                ]);
                            });
                        });
                        
                        const wsDetails = XLSX.utils.aoa_to_sheet(detailsData);
                        XLSX.utils.book_append_sheet(wb, wsDetails, 'Todos os Registros');
                        
                        // Aba: Detalhes por Arquivo
                        const filesData = [
                            ['Arquivo', 'Per√≠odo', 'M√™s/Ano', 'Total de Registros', 'Tipos de Registros', 'Valor Total', 'Itens 0200', 'Registros C170']
                        ];
                        
                        analysisData.filesData.forEach(file => {
                            const periodo = file.periodo;
                            filesData.push([
                                file.fileName,
                                periodo ? `${periodo.dataInicio} a ${periodo.dataFim}` : 'N√£o identificado',
                                periodo ? `${periodo.mes}/${periodo.ano}` : 'N/A',
                                file.totalRegistros,
                                Array.from(new Set(file.allRecords.map(r => r.registro))).join(', '),
                                file.totalValor,
                                file.items0200.size,
                                file.registrosC170.length
                            ]);
                        });
                        
                        const wsFiles = XLSX.utils.aoa_to_sheet(filesData);
                        XLSX.utils.book_append_sheet(wb, wsFiles, 'Detalhes por Arquivo');
                        
                        const timestamp = new Date().toISOString().slice(0,19).replace(/:/g, '-');
                        const fileName = `analise_sped_${timestamp}.xlsx`;
                        
                        XLSX.writeFile(wb, fileName);
                        
                        loading.style.display = 'none';
                        console.log('Arquivo Excel exportado com sucesso!');
                    }, 100);
                    
                } catch (error) {
                    console.error('Erro ao exportar para Excel:', error);
                    showError('Erro ao exportar para Excel: ' + error.message);
                    loading.style.display = 'none';
                }
            }
            
            function resetAnalysis() {
                resultsSection.style.display = 'none';
                error.style.display = 'none';
                debugContent.innerHTML = '';
                analysisData = null;
                filteredData = null;
                
                // Resetar pagina√ß√£o
                Object.keys(paginationState).forEach(tab => {
                    paginationState[tab].currentPage = 1;
                    paginationState[tab].totalPages = 1;
                    
                    // Corrigir seletores para evitar erros
                    let paginationElement;
                    if (tab === '0200') {
                        paginationElement = document.getElementById('pagination0200');
                    } else {
                        paginationElement = document.getElementById(`${tab}Pagination`);
                    }
                    
                    if (paginationElement) {
                        paginationElement.style.display = 'none';
                    }
                });
                
                filterAno.value = '';
                filterMes.value = '';
                filterRegistro.value = '';
                filterItemCodigo.value = '';
                filterItemDescricao.value = '';
                filterValorMin.value = '';
                filterValorMax.value = '';
                filterUnidade.value = '';
                
                // Resetar vista
                periodoView = true;
                togglePeriodoView.textContent = 'Vista Consolidada';
                document.querySelectorAll('#itensTab, #c170Tab, #tab0200, #detailsTab').forEach(table => {
                    table.classList.remove('view-consolidada');
                });
            }
            
            function showError(message) {
                error.textContent = message;
                error.style.display = 'block';
            }
            
            function getRegistroDescription(registro) {
                const descriptions = {
                    '0000': 'Abertura do Arquivo Digital', '0001': 'Abertura do Bloco', '0005': 'Dados Complementares',
                    '0100': 'Dados do Contabilista', '0150': 'Cadastro de Participantes', '0190': 'Identifica√ß√£o das Unidades de Medida',
                    '0200': 'Cadastro de Item', '0400': 'Cadastro de Natureza da Opera√ß√£o', '0450': 'Cadastro de Informa√ß√£o Complementar',
                    '0500': 'Contas Cont√°beis', '0600': 'Centro de Custos', 'C001': 'Abertura do Bloco C',
                    'C100': 'Nota Fiscal', 'C170': 'Itens da Nota Fiscal', 'C190': 'Registro Anal√≠tico do ICMS',
                    'C500': 'Nota Fiscal de Energia El√©trica', 'C600': 'Consolida√ß√£o Di√°ria', 'D001': 'Abertura do Bloco D',
                    'D100': 'Nota Fiscal de Servi√ßo', 'D500': 'Nota Fiscal de Servi√ßo Consolidada', 'E001': 'Abertura do Bloco E',
                    'E100': 'Per√≠odo da Apura√ß√£o', 'E110': 'Documentos Fiscais', 'E116': 'Obriga√ß√µes do ICMS'
                };
                return descriptions[registro] || 'Registro n√£o identificado';
            }
            
            function getTipoItemDescription(tipo) {
                const tipos = {
                    '00': 'Mercadoria para Revenda', '01': 'Mat√©ria-prima', '02': 'Embalagem',
                    '03': 'Produto em Processo', '04': 'Produto Acabado', '05': 'Subproduto',
                    '06': 'Produto Intermedi√°rio', '07': 'Material de Uso e Consumo', '08': 'Ativo Imobilizado',
                    '09': 'Servi√ßos', '10': 'Outros insumos', '99': 'Outras'
                };
                return tipo ? `${tipo} - ${tipos[tipo] || 'Desconhecido'}` : 'N√£o informado';
            }
        });
    </script>
</body>
</html>
