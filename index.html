<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisador SPED-EFD - Detalhamento por Ano/MÃªs</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary-color: #64748b;
            --accent-color: #ef4444;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --light-color: #f8fafc;
            --border-color: #e2e8f0;
            --text-color: #334155;
            --text-light: #64748b;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        
        body {
            background-color: #f1f5f9;
            color: var(--text-color);
            line-height: 1.6;
            font-size: 14px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            padding: 30px 0;
            text-align: center;
            border-radius: 0 0 12px 12px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }
        
        h1 {
            font-size: 2.2rem;
            margin-bottom: 8px;
            font-weight: 700;
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            font-weight: 400;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 24px;
            margin-bottom: 24px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border: 1px solid var(--border-color);
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .card-title {
            font-size: 1.4rem;
            color: var(--primary-color);
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
        }
        
        .upload-area {
            border: 2px dashed #cbd5e1;
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: #f8fafc;
        }
        
        .upload-area:hover, .upload-area.dragover {
            border-color: var(--primary-color);
            background-color: #eff6ff;
        }
        
        .upload-icon {
            font-size: 48px;
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s ease;
            text-decoration: none;
            text-align: center;
        }
        
        .btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-success {
            background: var(--success-color);
        }
        
        .btn-success:hover {
            background: #0da271;
        }
        
        .btn-danger {
            background: var(--accent-color);
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .btn-warning {
            background: var(--warning-color);
        }
        
        .btn-warning:hover {
            background: #d97706;
        }
        
        .btn-outline {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }
        
        .btn-outline:hover {
            background: #f8fafc;
        }
        
        .btn-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        .file-info {
            margin-top: 15px;
            padding: 16px;
            background-color: #f8fafc;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        
        .file-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }
        
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: white;
            margin-bottom: 6px;
            border-radius: 6px;
            border-left: 4px solid var(--primary-color);
            font-size: 0.9rem;
        }
        
        .file-item.error {
            border-left-color: var(--accent-color);
            background-color: #fef2f2;
        }
        
        .file-item.success {
            border-left-color: var(--success-color);
            background-color: #f0fdf4;
        }
        
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        
        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            font-size: 0.9rem;
        }
        
        th, td {
            border: 1px solid var(--border-color);
            padding: 10px 12px;
            text-align: left;
        }
        
        th {
            background-color: #f8fafc;
            color: var(--text-color);
            font-weight: 600;
            position: sticky;
            top: 0;
            border-bottom: 2px solid var(--border-color);
        }
        
        tr:nth-child(even) {
            background-color: #f8fafc;
        }
        
        tr:hover {
            background-color: #f1f5f9;
        }
        
        .results-section {
            display: none;
        }
        
        .summary-card {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 16px;
            margin-bottom: 25px;
        }
        
        .summary-item {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: var(--shadow);
            text-align: center;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 120px;
        }
        
        .summary-item.highlight {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border-color: #047857;
        }
        
        .summary-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--primary-color);
            margin: 10px 0;
            line-height: 1.2;
        }
        
        .summary-item.highlight .summary-value {
            color: white;
        }
        
        .summary-label {
            color: var(--text-light);
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .summary-item.highlight .summary-label {
            color: rgba(255, 255, 255, 0.9);
        }
        
        .error {
            color: var(--accent-color);
            background-color: #fef2f2;
            padding: 12px 16px;
            border-radius: 6px;
            margin-top: 15px;
            display: none;
            border: 1px solid #fecaca;
            font-size: 0.9rem;
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: var(--text-light);
            font-size: 0.85rem;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
            gap: 4px;
        }
        
        .tab {
            padding: 10px 16px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 0.9rem;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
            color: var(--text-light);
            font-weight: 500;
            border-radius: 6px 6px 0 0;
        }
        
        .tab:hover {
            color: var(--primary-color);
            background: #f1f5f9;
        }
        
        .tab.active {
            border-bottom-color: var(--primary-color);
            color: var(--primary-color);
            font-weight: 600;
            background: #eff6ff;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .debug-info {
            background: #fffbeb;
            border: 1px solid #fed7aa;
            border-radius: 6px;
            padding: 12px;
            margin-top: 10px;
            font-size: 0.85rem;
            display: none;
        }
        
        .filter-section {
            margin-bottom: 20px;
            padding: 16px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        
        .filter-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 12px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--text-color);
            font-size: 0.9rem;
        }
        
        .filter-input, .filter-select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.9rem;
            transition: border-color 0.2s;
        }
        
        .filter-input:focus, .filter-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .registro-badge {
            display: inline-block;
            padding: 4px 8px;
            background: var(--primary-color);
            color: white;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .item-highlight {
            background-color: #eff6ff !important;
            border-left: 4px solid var(--primary-color);
        }
        
        .valor-cell {
            font-weight: 600;
            color: var(--success-color);
        }
        
        .info-box {
            background: #eff6ff;
            border-left: 4px solid var(--primary-color);
            padding: 16px;
            margin: 16px 0;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        .periodo-badge {
            display: inline-block;
            padding: 4px 8px;
            background: var(--warning-color);
            color: white;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .total-row {
            background-color: #f0fdf4 !important;
            font-weight: 600;
            border-top: 2px solid var(--success-color);
        }
        
        .section-title {
            font-size: 1.2rem;
            color: var(--primary-color);
            margin-bottom: 16px;
            font-weight: 600;
        }
        
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .status-success {
            background: #f0fdf4;
            color: var(--success-color);
            border: 1px solid #bbf7d0;
        }
        
        .status-error {
            background: #fef2f2;
            color: var(--accent-color);
            border: 1px solid #fecaca;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-light);
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        .summary-value-large {
            font-size: 1.5rem;
            word-break: break-all;
            overflow-wrap: break-word;
        }
        
        .btn-group-fixed {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 20px;
            justify-content: flex-start;
            align-items: center;
        }
        
        .btn-fixed {
            flex: 0 1 auto;
            min-width: 140px;
        }

        /* Estilos para paginaÃ§Ã£o */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .pagination-info {
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .pagination-btn {
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pagination-btn:hover:not(:disabled) {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .performance-warning {
            background: #fffbeb;
            border: 1px solid #fed7aa;
            border-radius: 6px;
            padding: 12px;
            margin: 10px 0;
            font-size: 0.9rem;
            display: none;
        }

        .batch-processing {
            display: none;
            text-align: center;
            padding: 20px;
            background: #f8fafc;
            border-radius: 8px;
            margin: 10px 0;
        }

        .batch-progress {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            margin: 10px 0;
            overflow: hidden;
        }

        .batch-progress-bar {
            height: 100%;
            background: var(--primary-color);
            transition: width 0.3s ease;
        }

        .current-file {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-top: 8px;
        }

        .view-consolidada .periodo-column {
            display: none;
        }

        .view-consolidada .periodo-badge {
            display: none;
        }

        /* NOVO: Indicador de processamento em background */
        .background-processing {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success-color);
            color: white;
            padding: 10px 15px;
            border-radius: 6px;
            box-shadow: var(--shadow);
            z-index: 1000;
            display: none;
            align-items: center;
            gap: 8px;
        }

        .background-processing .spinner {
            width: 16px;
            height: 16px;
            border-width: 2px;
            margin: 0;
        }

        /* NOVO: Estilo para CNPJ e NOME */
        .cnpj-badge {
            display: inline-block;
            padding: 4px 8px;
            background: var(--secondary-color);
            color: white;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            font-family: monospace;
        }

        .empresa-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .empresa-nome {
            font-weight: 600;
            color: var(--text-color);
            font-size: 0.85rem;
        }

        .empresa-cnpj {
            font-size: 0.75rem;
            color: var(--text-light);
            font-family: monospace;
        }

        .filter-empresa-group {
            grid-column: span 2;
        }

        /* Novos estilos para otimizaÃ§Ã£o */
        .memory-usage {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 6px;
            padding: 8px 12px;
            margin: 10px 0;
            font-size: 0.8rem;
            display: none;
        }

        .compression-info {
            background: #dbeafe;
            border: 1px solid #3b82f6;
            border-radius: 6px;
            padding: 8px 12px;
            margin: 10px 0;
            font-size: 0.8rem;
            display: none;
        }

        @media (max-width: 1024px) {
            .summary-card {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .filter-row {
                grid-template-columns: repeat(2, 1fr);
            }

            .filter-empresa-group {
                grid-column: span 2;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .btn-group, .btn-group-fixed {
                flex-direction: column;
            }
            
            .btn, .btn-fixed {
                width: 100%;
            }
            
            table {
                display: block;
                overflow-x: auto;
            }
            
            .tabs {
                flex-direction: column;
                gap: 0;
            }
            
            .tab {
                text-align: left;
                border-bottom: 1px solid var(--border-color);
                border-radius: 0;
            }
            
            .filter-row {
                grid-template-columns: 1fr;
            }

            .filter-empresa-group {
                grid-column: span 1;
            }
            
            .summary-card {
                grid-template-columns: repeat(2, 1fr);
            }

            .pagination {
                flex-wrap: wrap;
            }

            .background-processing {
                top: 10px;
                right: 10px;
                left: 10px;
                text-align: center;
            }
        }
        
        @media (max-width: 480px) {
            .summary-card {
                grid-template-columns: 1fr;
            }
            
            .summary-value {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- NOVO: Indicador de processamento em background -->
    <div class="background-processing" id="backgroundProcessing">
        <div class="spinner"></div>
        <span>Processando em background...</span>
    </div>

    <header>
        <div class="container">
            <h1>Analisador SPED-EFD</h1>
            <p class="subtitle">Detalhamento por Ano/MÃªs - AnÃ¡lise completa com separaÃ§Ã£o por perÃ­odo, CNPJ e Nome da Empresa</p>
        </div>
    </header>
    
    <div class="container">
        <div class="card">
            <h2 class="card-title">Carregar Arquivos SPED-EFD</h2>
            
            <div class="info-box">
                <strong>Como funciona:</strong> O sistema identifica automaticamente:
                <ul style="margin: 10px 0 0 20px;">
                    <li><strong>SeparaÃ§Ã£o por Ano/MÃªs</strong> de cada arquivo</li>
                    <li><strong>CNPJ e Nome</strong> da empresa de cada arquivo SPED</li>
                    <li><strong>Registro 0200:</strong> CÃ³digo e descriÃ§Ã£o do item</li>
                    <li><strong>Registro C170:</strong> Valores, quantidades e complementos</li>
                    <li><strong>Totais por tipo de registro</strong> em cada perÃ­odo</li>
                    <li><strong>Todos os registros</strong> do SPED-EFD</li>
                </ul>
            </div>

            <div class="memory-usage" id="memoryUsage">
                <strong>Uso de MemÃ³ria:</strong> <span id="memoryUsageText">0 MB</span>
            </div>

            <div class="compression-info" id="compressionInfo">
                <strong>OtimizaÃ§Ã£o:</strong> <span id="compressionText">CompressÃ£o de dados ativa</span>
            </div>
            
            <div class="performance-warning" id="performanceWarning">
                <strong>â ï¸ Aviso de Performance:</strong> Muitos arquivos detectados. O processamento pode levar alguns minutos. Recomendado processar em lotes menores.
            </div>
            
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">ð</div>
                <p>Clique aqui ou arraste mÃºltiplos arquivos SPED-EFD para anÃ¡lise</p>
                <p><small>Arquivos aceitos: .txt (mÃºltipla seleÃ§Ã£o permitida) - Suporte a grandes volumes (1GB+)</small></p>
                <input type="file" id="fileInput" accept=".txt" multiple style="display: none;">
            </div>
            
            <div class="file-info">
                <p><strong>Arquivos carregados:</strong> <span id="fileCount">0</span> (<span id="totalSize">0 MB</span>)</p>
                <div class="file-list" id="fileList"></div>
            </div>

            <div class="batch-processing" id="batchProcessing">
                <div class="spinner"></div>
                <p>Processando em lote: <span id="batchProgressText">0%</span></p>
                <div class="batch-progress">
                    <div class="batch-progress-bar" id="batchProgressBar" style="width: 0%"></div>
                </div>
                <p class="current-file" id="currentFile">Processando arquivos...</p>
                <p><small>Processando arquivos... Isso pode levar alguns minutos para grandes volumes</small></p>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-success" id="processBtn" disabled>
                    <span>Processar Arquivos</span>
                </button>
                <button class="btn btn-outline" id="clearBtn">
                    <span>Limpar Arquivos</span>
                </button>
                <button class="btn btn-warning" id="optimizeBtn">
                    <span>Modo Otimizado</span>
                </button>
            </div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Processando arquivos...</p>
            </div>
            
            <div class="error" id="error"></div>
            
            <div class="debug-info" id="debugInfo">
                <strong>InformaÃ§Ãµes de Debug:</strong>
                <div id="debugContent"></div>
            </div>
        </div>
        
        <div class="results-section" id="resultsSection">
            <div class="card">
                <h2 class="card-title">Resumo Geral por PerÃ­odo</h2>
                <div class="summary-card">
                    <div class="summary-item">
                        <div class="summary-label">Arquivos Processados</div>
                        <div class="summary-value" id="processedFiles">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">PerÃ­odos Encontrados</div>
                        <div class="summary-value" id="totalPeriodos">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Total de Registros</div>
                        <div class="summary-value" id="totalRegistros">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Empresas Diferentes</div>
                        <div class="summary-value" id="totalEmpresas">0</div>
                        <small>CNPJs Ãºnicos corretamente agrupados</small>
                    </div>
                    <!-- CORREÃÃO: Card do Montante Total adicionado -->
                    <div class="summary-item highlight">
                        <div class="summary-label">Total Geral do Montante</div>
                        <div class="summary-value" id="totalMontante">R$ 0,00</div>
                        <small>Valor total consolidado</small>
                    </div>
                </div>
                
                <div class="btn-group-fixed">
                    <button class="btn btn-success btn-fixed" id="exportBtn">
                        <span>Exportar para Excel</span>
                    </button>
                    <button class="btn btn-fixed" id="applyFiltersBtn">
                        <span>Aplicar Filtros</span>
                    </button>
                    <button class="btn btn-outline btn-fixed" id="togglePeriodoView">
                        <span>Vista Consolidada</span>
                    </button>
                    <button class="btn btn-outline btn-fixed" id="debugToggle">
                        <span>Mostrar Debug</span>
                    </button>
                    <button class="btn btn-danger btn-fixed" id="resetBtn">
                        <span>Nova AnÃ¡lise</span>
                    </button>
                </div>
            </div>

            <div class="filter-section">
                <h3 class="section-title">Filtros AvanÃ§ados</h3>
                <div class="filter-row">
                    <div class="filter-group filter-empresa-group">
                        <label class="filter-label">Empresa (CNPJ ou Nome)</label>
                        <input type="text" class="filter-input" id="filterEmpresa" placeholder="Digite CNPJ ou nome da empresa">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Ano</label>
                        <select class="filter-select" id="filterAno">
                            <option value="">Todos os anos</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">MÃªs</label>
                        <select class="filter-select" id="filterMes">
                            <option value="">Todos os meses</option>
                            <option value="01">Janeiro</option>
                            <option value="02">Fevereiro</option>
                            <option value="03">MarÃ§o</option>
                            <option value="04">Abril</option>
                            <option value="05">Maio</option>
                            <option value="06">Junho</option>
                            <option value="07">JulÃ§o</option>
                            <option value="08">Agosto</option>
                            <option value="09">Setembro</option>
                            <option value="10">Outubro</option>
                            <option value="11">Novembro</option>
                            <option value="12">Dezembro</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Tipo de Registro</label>
                        <select class="filter-select" id="filterRegistro">
                            <option value="">Todos os registros</option>
                        </select>
                    </div>
                </div>
                <div class="filter-row">
                    <div class="filter-group">
                        <label class="filter-label">CÃ³digo do Item</label>
                        <input type="text" class="filter-input" id="filterItemCodigo" placeholder="CÃ³digo exato do item">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">DescriÃ§Ã£o do Item</label>
                        <input type="text" class="filter-input" id="filterItemDescricao" placeholder="Parte da descriÃ§Ã£o">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Valor MÃ­nimo</label>
                        <input type="number" class="filter-input" id="filterValorMin" placeholder="0.00" step="0.01" min="0">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Valor MÃ¡ximo</label>
                        <input type="number" class="filter-input" id="filterValorMax" placeholder="0.00" step="0.01" min="0">
                    </div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-outline" id="clearFiltersBtn">
                        <span>Limpar Filtros</span>
                    </button>
                </div>
            </div>
            
            <div class="tabs">
                <button class="tab active" data-tab="periodo">Resumo por PerÃ­odo</button>
                <button class="tab" data-tab="registros">Totais por Registro</button>
                <button class="tab" data-tab="itens">Itens com Valores</button>
                <button class="tab" data-tab="c170">Registros C170</button>
                <button class="tab" data-tab="0200">Cadastro de Itens</button>
                <button class="tab" data-tab="details">Todos os Registros</button>
                <button class="tab" data-tab="files">Detalhes por Arquivo</button>
                <button class="tab" data-tab="empresas">Empresas</button>
            </div>
            
            <div class="tab-content active" id="periodoTab">
                <div class="card">
                    <h2 class="card-title">Resumo por PerÃ­odo (Ano/MÃªs)</h2>
                    <div class="pagination" id="periodoPagination" style="display: none;">
                        <button class="pagination-btn" id="periodoFirst">Primeira</button>
                        <button class="pagination-btn" id="periodoPrev">Anterior</button>
                        <span class="pagination-info" id="periodoPageInfo">PÃ¡gina 1 de 1</span>
                        <button class="pagination-btn" id="periodoNext">PrÃ³xima</button>
                        <button class="pagination-btn" id="periodoLast">Ãltima</button>
                        <input type="number" class="pagination-input" id="periodoPageInput" min="1" value="1">
                        <button class="pagination-btn" id="periodoGo">Ir</button>
                    </div>
                    <table id="periodoTable">
                        <thead>
                            <tr>
                                <th>PerÃ­odo</th>
                                <th>Arquivos</th>
                                <th>Empresas</th>
                                <th>Total de Registros</th>
                                <th>Tipos de Registros</th>
                                <th>Valor Total</th>
                                <th>Itens Cadastrados</th>
                                <th>Registros C170</th>
                                <th>Valor C170</th>
                            </tr>
                        </thead>
                        <tbody id="periodoTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="tab-content" id="registrosTab">
                <div class="card">
                    <h2 class="card-title">Totais por Tipo de Registro</h2>
                    <div class="pagination" id="registrosPagination" style="display: none;">
                        <button class="pagination-btn" id="registrosFirst">Primeira</button>
                        <button class="pagination-btn" id="registrosPrev">Anterior</button>
                        <span class="pagination-info" id="registrosPageInfo">PÃ¡gina 1 de 1</span>
                        <button class="pagination-btn" id="registrosNext">PrÃ³xima</button>
                        <button class="pagination-btn" id="registrosLast">Ãltima</button>
                        <input type="number" class="pagination-input" id="registrosPageInput" min="1" value="1">
                        <button class="pagination-btn" id="registrosGo">Ir</button>
                    </div>
                    <table id="registrosTable">
                        <thead>
                            <tr>
                                <th>Tipo de Registro</th>
                                <th>DescriÃ§Ã£o</th>
                                <th>Quantidade Total</th>
                                <th>Valor Total</th>
                                <th>PerÃ­odos</th>
                                <th>Arquivos</th>
                                <th>Empresas</th>
                            </tr>
                        </thead>
                        <tbody id="registrosTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="tab-content" id="itensTab">
                <div class="card">
                    <h2 class="card-title">Itens com Valores Associados</h2>
                    <p><em>AssociaÃ§Ã£o entre registros 0200 (cadastro) e C170 (valores) por perÃ­odo</em></p>
                    <div class="pagination" id="itensPagination" style="display: none;">
                        <button class="pagination-btn" id="itensFirst">Primeira</button>
                        <button class="pagination-btn" id="itensPrev">Anterior</button>
                        <span class="pagination-info" id="itensPageInfo">PÃ¡gina 1 de 1</span>
                        <button class="pagination-btn" id="itensNext">PrÃ³xima</button>
                        <button class="pagination-btn" id="itensLast">Ãltima</button>
                        <input type="number" class="pagination-input" id="itensPageInput" min="1" value="1">
                        <button class="pagination-btn" id="itensGo">Ir</button>
                    </div>
                    <table id="itensTable">
                        <thead>
                            <tr>
                                <th>CÃ³digo</th>
                                <th>DescriÃ§Ã£o</th>
                                <th>Unidade</th>
                                <th class="periodo-column">PerÃ­odo</th>
                                <th>Quantidade Total</th>
                                <th>Valor Total</th>
                                <th>Valor UnitÃ¡rio MÃ©dio</th>
                                <th>Qtde. C170</th>
                                <th>Arquivos</th>
                                <th>Empresas</th>
                            </tr>
                        </thead>
                        <tbody id="itensTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="tab-content" id="c170Tab">
                <div class="card">
                    <h2 class="card-title">Registros C170 - Itens de Documentos</h2>
                    <div class="pagination" id="c170Pagination" style="display: none;">
                        <button class="pagination-btn" id="c170First">Primeira</button>
                        <button class="pagination-btn" id="c170Prev">Anterior</button>
                        <span class="pagination-info" id="c170PageInfo">PÃ¡gina 1 de 1</span>
                        <button class="pagination-btn" id="c170Next">PrÃ³xima</button>
                        <button class="pagination-btn" id="c170Last">Ãltima</button>
                        <input type="number" class="pagination-input" id="c170PageInput" min="1" value="1">
                        <button class="pagination-btn" id="c170Go">Ir</button>
                    </div>
                    <table id="c170Table">
                        <thead>
                            <tr>
                                <th class="periodo-column">PerÃ­odo</th>
                                <th>Arquivo</th>
                                <th>Empresa</th>
                                <th>CÃ³digo Item</th>
                                <th>DescriÃ§Ã£o Item</th>
                                <th>DescriÃ§Ã£o Complementar</th>
                                <th>Quantidade</th>
                                <th>Unidade</th>
                                <th>Valor Item</th>
                                <th>Valor Desconto</th>
                                <th>Base ICMS</th>
                                <th>Valor ICMS</th>
                            </tr>
                        </thead>
                        <tbody id="c170TableBody">
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="tab-content" id="tab0200">
                <div class="card">
                    <h2 class="card-title">Cadastro de Itens (Registro 0200)</h2>
                    <div class="pagination" id="pagination0200" style="display: none;">
                        <button class="pagination-btn" id="first0200">Primeira</button>
                        <button class="pagination-btn" id="prev0200">Anterior</button>
                        <span class="pagination-info" id="pageInfo0200">PÃ¡gina 1 de 1</span>
                        <button class="pagination-btn" id="next0200">PrÃ³xima</button>
                        <button class="pagination-btn" id="last0200">Ãltima</button>
                        <input type="number" class="pagination-input" id="pageInput0200" min="1" value="1">
                        <button class="pagination-btn" id="go0200">Ir</button>
                    </div>
                    <table id="table0200">
                        <thead>
                            <tr>
                                <th class="periodo-column">PerÃ­odo</th>
                                <th>Arquivo</th>
                                <th>Empresa</th>
                                <th>CÃ³digo Item</th>
                                <th>DescriÃ§Ã£o</th>
                                <th>CÃ³digo Barras</th>
                                <th>Unidade</th>
                                <th>Tipo Item</th>
                                <th>CÃ³digo NCM</th>
                            </tr>
                        </thead>
                        <tbody id="table0200Body">
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="tab-content" id="detailsTab">
                <div class="card">
                    <h2 class="card-title">Todos os Registros Detalhados</h2>
                    <div class="pagination" id="detailsPagination" style="display: none;">
                        <button class="pagination-btn" id="detailsFirst">Primeira</button>
                        <button class="pagination-btn" id="detailsPrev">Anterior</button>
                        <span class="pagination-info" id="detailsPageInfo">PÃ¡gina 1 de 1</span>
                        <button class="pagination-btn" id="detailsNext">PrÃ³xima</button>
                        <button class="pagination-btn" id="detailsLast">Ãltima</button>
                        <input type="number" class="pagination-input" id="detailsPageInput" min="1" value="1">
                        <button class="pagination-btn" id="detailsGo">Ir</button>
                    </div>
                    <table id="detailsTable">
                        <thead>
                            <tr>
                                <th class="periodo-column">PerÃ­odo</th>
                                <th>Arquivo</th>
                                <th>Empresa</th>
                                <th>Registro</th>
                                <th>Item CÃ³digo</th>
                                <th>Item DescriÃ§Ã£o</th>
                                <th>Valor</th>
                                <th>Data</th>
                                <th>Linha Completa</th>
                            </tr>
                        </thead>
                        <tbody id="detailsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="tab-content" id="filesTab">
                <div class="card">
                    <h2 class="card-title">Detalhes por Arquivo</h2>
                    <div class="pagination" id="filesPagination" style="display: none;">
                        <button class="pagination-btn" id="filesFirst">Primeira</button>
                        <button class="pagination-btn" id="filesPrev">Anterior</button>
                        <span class="pagination-info" id="filesPageInfo">PÃ¡gina 1 de 1</span>
                        <button class="pagination-btn" id="filesNext">PrÃ³xima</button>
                        <button class="pagination-btn" id="filesLast">Ãltima</button>
                        <input type="number" class="pagination-input" id="filesPageInput" min="1" value="1">
                        <button class="pagination-btn" id="filesGo">Ir</button>
                    </div>
                    <table id="filesTable">
                        <thead>
                            <tr>
                                <th>Arquivo</th>
                                <th>Empresa</th>
                                <th>PerÃ­odo</th>
                                <th>MÃªs/Ano</th>
                                <th>Total de Registros</th>
                                <th>Tipos de Registros</th>
                                <th>Valor Total</th>
                                <th>Itens 0200</th>
                                <th>Registros C170</th>
                            </tr>
                        </thead>
                        <tbody id="filesTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- NOVA ABA: Empresas -->
            <div class="tab-content" id="empresasTab">
                <div class="card">
                    <h2 class="card-title">Empresas Encontradas</h2>
                    <div class="pagination" id="empresasPagination" style="display: none;">
                        <button class="pagination-btn" id="empresasFirst">Primeira</button>
                        <button class="pagination-btn" id="empresasPrev">Anterior</button>
                        <span class="pagination-info" id="empresasPageInfo">PÃ¡gina 1 de 1</span>
                        <button class="pagination-btn" id="empresasNext">PrÃ³xima</button>
                        <button class="pagination-btn" id="empresasLast">Ãltima</button>
                        <input type="number" class="pagination-input" id="empresasPageInput" min="1" value="1">
                        <button class="pagination-btn" id="empresasGo">Ir</button>
                    </div>
                    <table id="empresasTable">
                        <thead>
                            <tr>
                                <th>CNPJ</th>
                                <th>Nome da Empresa</th>
                                <th>Arquivos</th>
                                <th>PerÃ­odos</th>
                                <th>Total de Registros</th>
                                <th>Valor Total</th>
                                <th>Itens Cadastrados</th>
                                <th>Registros C170</th>
                            </tr>
                        </thead>
                        <tbody id="empresasTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <footer>
        <div class="container">
            <p>Analisador SPED-EFD - Detalhamento por Ano/MÃªs &copy; 2025 - AnÃ¡lise completa com separaÃ§Ã£o por perÃ­odo, CNPJ e Nome da Empresa</p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // CONFIGURAÃÃES OTIMIZADAS PARA GRANDES VOLUMES (1GB+)
            const PERFORMANCE_CONFIG = {
                BATCH_SIZE: 5, // Reduzido para lidar com arquivos grandes
                PAGE_SIZE: 50,
                VIRTUAL_SCROLL_THRESHOLD: 500,
                YIELD_INTERVAL: 10, // Mais frequente para nÃ£o travar a UI
                MAX_FILES_WARNING: 50,
                MEMORY_LIMIT: 5000000,
                MAX_FILE_SIZE_MB: 500, // Limite de 500MB por arquivo
                COMPRESSION_ENABLED: true,
                STREAMING_ENABLED: true
            };

            // Elementos da interface
            const fileInput = document.getElementById('fileInput');
            const uploadArea = document.getElementById('uploadArea');
            const fileCount = document.getElementById('fileCount');
            const fileList = document.getElementById('fileList');
            const processBtn = document.getElementById('processBtn');
            const clearBtn = document.getElementById('clearBtn');
            const optimizeBtn = document.getElementById('optimizeBtn');
            const resultsSection = document.getElementById('resultsSection');
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const exportBtn = document.getElementById('exportBtn');
            const resetBtn = document.getElementById('resetBtn');
            const debugToggle = document.getElementById('debugToggle');
            const debugInfo = document.getElementById('debugInfo');
            const debugContent = document.getElementById('debugContent');
            const applyFiltersBtn = document.getElementById('applyFiltersBtn');
            const clearFiltersBtn = document.getElementById('clearFiltersBtn');
            const togglePeriodoView = document.getElementById('togglePeriodoView');
            const batchProcessing = document.getElementById('batchProcessing');
            const batchProgressBar = document.getElementById('batchProgressBar');
            const batchProgressText = document.getElementById('batchProgressText');
            const currentFile = document.getElementById('currentFile');
            const performanceWarning = document.getElementById('performanceWarning');
            const backgroundProcessing = document.getElementById('backgroundProcessing');
            const memoryUsage = document.getElementById('memoryUsage');
            const memoryUsageText = document.getElementById('memoryUsageText');
            const compressionInfo = document.getElementById('compressionInfo');
            const compressionText = document.getElementById('compressionText');
            const totalSize = document.getElementById('totalSize');
            
            // CORREÃÃO: Elemento para Total Geral do Montante
            const totalMontante = document.getElementById('totalMontante');
            
            // NOVO: Filtro Empresa (CNPJ ou Nome)
            const filterEmpresa = document.getElementById('filterEmpresa');
            
            // Elementos de resumo
            const processedFiles = document.getElementById('processedFiles');
            const totalPeriodos = document.getElementById('totalPeriodos');
            const totalRegistros = document.getElementById('totalRegistros');
            const totalEmpresas = document.getElementById('totalEmpresas');
            
            // Filtros
            const filterAno = document.getElementById('filterAno');
            const filterMes = document.getElementById('filterMes');
            const filterRegistro = document.getElementById('filterRegistro');
            const filterItemCodigo = document.getElementById('filterItemCodigo');
            const filterItemDescricao = document.getElementById('filterItemDescricao');
            const filterValorMin = document.getElementById('filterValorMin');
            const filterValorMax = document.getElementById('filterValorMax');
            
            // Tabelas
            const periodoTableBody = document.getElementById('periodoTableBody');
            const registrosTableBody = document.getElementById('registrosTableBody');
            const itensTableBody = document.getElementById('itensTableBody');
            const c170TableBody = document.getElementById('c170TableBody');
            const table0200Body = document.getElementById('table0200Body');
            const detailsTableBody = document.getElementById('detailsTableBody');
            const filesTableBody = document.getElementById('filesTableBody');
            const empresasTableBody = document.getElementById('empresasTableBody');
            
            // Tabs
            const tabs = document.querySelectorAll('.tab');
            
            let filesData = [];
            let analysisData = null;
            let filteredData = null;
            let debugMode = false;
            let periodoView = true;
            let isProcessing = false;
            let empresaMap = new Map(); // Mapa: nomeArquivo -> {cnpj, nome}
            let optimizedMode = false;
            let totalFilesSize = 0;

            // Estado de paginaÃ§Ã£o
            const paginationState = {
                periodo: { currentPage: 1, totalPages: 1, pageSize: PERFORMANCE_CONFIG.PAGE_SIZE },
                registros: { currentPage: 1, totalPages: 1, pageSize: PERFORMANCE_CONFIG.PAGE_SIZE },
                itens: { currentPage: 1, totalPages: 1, pageSize: PERFORMANCE_CONFIG.PAGE_SIZE },
                c170: { currentPage: 1, totalPages: 1, pageSize: PERFORMANCE_CONFIG.PAGE_SIZE },
                '0200': { currentPage: 1, totalPages: 1, pageSize: PERFORMANCE_CONFIG.PAGE_SIZE },
                details: { currentPage: 1, totalPages: 1, pageSize: PERFORMANCE_CONFIG.PAGE_SIZE },
                files: { currentPage: 1, totalPages: 1, pageSize: PERFORMANCE_CONFIG.PAGE_SIZE },
                empresas: { currentPage: 1, totalPages: 1, pageSize: PERFORMANCE_CONFIG.PAGE_SIZE }
            };

            // CORREÃÃO: FunÃ§Ã£o para normalizar CNPJ (remove caracteres especiais e padroniza)
            function normalizeCnpj(cnpj) {
                if (!cnpj || cnpj === 'NÃ£o identificado' || cnpj === 'Erro') return cnpj;
                
                // Remove tudo que nÃ£o Ã© nÃºmero
                const cnpjLimpo = cnpj.replace(/\D/g, '');
                
                // Verifica se tem 14 dÃ­gitos (CNPJ vÃ¡lido)
                if (cnpjLimpo.length === 14) {
                    return cnpjLimpo;
                }
                
                return cnpj;
            }

            // CORREÃÃO: FunÃ§Ã£o para normalizar nome da empresa
            function normalizeEmpresaName(nome) {
                if (!nome || nome === 'NÃ£o identificado' || nome === 'Erro') return nome;
                
                return nome.trim()
                    .toUpperCase()
                    .normalize('NFD')
                    .replace(/[\u0300-\u036f]/g, '') // Remove acentos
                    .replace(/\s+/g, ' ') // EspaÃ§os mÃºltiplos para Ãºnico
                    .replace(/[^A-Z0-9\s]/g, '') // Remove caracteres especiais, mantÃ©m letras, nÃºmeros e espaÃ§os
                    .trim();
            }

            // Eventos
            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                if (e.dataTransfer.files.length) handleFiles(e.dataTransfer.files);
            });
            
            fileInput.addEventListener('change', () => {
                if (fileInput.files.length) handleFiles(fileInput.files);
            });
            
            processBtn.addEventListener('click', processFiles);
            clearBtn.addEventListener('click', clearFiles);
            optimizeBtn.addEventListener('click', toggleOptimizedMode);
            exportBtn.addEventListener('click', exportToExcel);
            resetBtn.addEventListener('click', resetAnalysis);
            debugToggle.addEventListener('click', toggleDebug);
            applyFiltersBtn.addEventListener('click', applyFilters);
            clearFiltersBtn.addEventListener('click', clearFilters);
            togglePeriodoView.addEventListener('click', togglePeriodoViewHandler);
            
            // Eventos para validaÃ§Ã£o de filtros
            filterValorMin.addEventListener('input', validateValorFilters);
            filterValorMax.addEventListener('input', validateValorFilters);
            
            // Eventos para tabs
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    tabs.forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
                    this.classList.add('active');
                    
                    let contentId = tabId + 'Tab';
                    if (tabId === '0200') {
                        contentId = 'tab0200';
                    }
                    
                    const contentElement = document.getElementById(contentId);
                    if (contentElement) {
                        contentElement.classList.add('active');
                    }
                });
            });

            // Atualizar uso de memÃ³ria periodicamente
            setInterval(updateMemoryUsage, 2000);

            function toggleOptimizedMode() {
                optimizedMode = !optimizedMode;
                optimizeBtn.textContent = optimizedMode ? 'Modo Normal' : 'Modo Otimizado';
                optimizeBtn.classList.toggle('btn-warning', !optimizedMode);
                optimizeBtn.classList.toggle('btn-success', optimizedMode);
                
                if (optimizedMode) {
                    PERFORMANCE_CONFIG.BATCH_SIZE = 3;
                    PERFORMANCE_CONFIG.COMPRESSION_ENABLED = true;
                    PERFORMANCE_CONFIG.STREAMING_ENABLED = true;
                    compressionInfo.style.display = 'block';
                    compressionText.textContent = 'Modo otimizado ativo - Processamento mais lento mas suporta volumes maiores';
                } else {
                    PERFORMANCE_CONFIG.BATCH_SIZE = 10;
                    PERFORMANCE_CONFIG.COMPRESSION_ENABLED = false;
                    PERFORMANCE_CONFIG.STREAMING_ENABLED = false;
                    compressionInfo.style.display = 'none';
                }
            }

            // Configurar eventos de paginaÃ§Ã£o para cada aba
            setupPaginationEvents('periodo');
            setupPaginationEvents('registros');
            setupPaginationEvents('itens');
            setupPaginationEvents('c170');
            setupPaginationEvents('0200');
            setupPaginationEvents('details');
            setupPaginationEvents('files');
            setupPaginationEvents('empresas');

            function setupPaginationEvents(tabName) {
                let firstBtn, prevBtn, nextBtn, lastBtn, pageInput, goBtn;
                
                if (tabName === '0200') {
                    firstBtn = document.getElementById('first0200');
                    prevBtn = document.getElementById('prev0200');
                    nextBtn = document.getElementById('next0200');
                    lastBtn = document.getElementById('last0200');
                    pageInput = document.getElementById('pageInput0200');
                    goBtn = document.getElementById('go0200');
                } else {
                    firstBtn = document.getElementById(`${tabName}First`);
                    prevBtn = document.getElementById(`${tabName}Prev`);
                    nextBtn = document.getElementById(`${tabName}Next`);
                    lastBtn = document.getElementById(`${tabName}Last`);
                    pageInput = document.getElementById(`${tabName}PageInput`);
                    goBtn = document.getElementById(`${tabName}Go`);
                }

                if (firstBtn) firstBtn.addEventListener('click', () => changePage(tabName, 1));
                if (prevBtn) prevBtn.addEventListener('click', () => changePage(tabName, paginationState[tabName].currentPage - 1));
                if (nextBtn) nextBtn.addEventListener('click', () => changePage(tabName, paginationState[tabName].currentPage + 1));
                if (lastBtn) lastBtn.addEventListener('click', () => changePage(tabName, paginationState[tabName].totalPages));
                if (goBtn && pageInput) {
                    goBtn.addEventListener('click', () => {
                        const page = parseInt(pageInput.value);
                        if (page >= 1 && page <= paginationState[tabName].totalPages) {
                            changePage(tabName, page);
                        }
                    });
                }
            }

            function changePage(tabName, newPage) {
                if (newPage < 1 || newPage > paginationState[tabName].totalPages) return;
                
                paginationState[tabName].currentPage = newPage;
                updatePaginationInfo(tabName);
                
                if (filteredData) {
                    switch(tabName) {
                        case 'periodo':
                            displayPeriodoTable(filteredData);
                            break;
                        case 'registros':
                            displayRegistrosTable(filteredData);
                            break;
                        case 'itens':
                            displayItensTable(filteredData);
                            break;
                        case 'c170':
                            displayC170Table(filteredData);
                            break;
                        case '0200':
                            display0200Table(filteredData);
                            break;
                        case 'details':
                            displayDetailsTable(filteredData);
                            break;
                        case 'files':
                            displayFilesTable(filteredData);
                            break;
                        case 'empresas':
                            displayEmpresasTable(filteredData);
                            break;
                    }
                }
            }

            function updatePaginationInfo(tabName) {
                const state = paginationState[tabName];
                let pageInfo, pageInput;
                
                if (tabName === '0200') {
                    pageInfo = document.getElementById('pageInfo0200');
                    pageInput = document.getElementById('pageInput0200');
                } else {
                    pageInfo = document.getElementById(`${tabName}PageInfo`);
                    pageInput = document.getElementById(`${tabName}PageInput`);
                }

                if (pageInfo) {
                    pageInfo.textContent = `PÃ¡gina ${state.currentPage} de ${state.totalPages}`;
                }
                if (pageInput) {
                    pageInput.value = state.currentPage;
                }
                
                let firstBtn, prevBtn, nextBtn, lastBtn;
                
                if (tabName === '0200') {
                    firstBtn = document.getElementById('first0200');
                    prevBtn = document.getElementById('prev0200');
                    nextBtn = document.getElementById('next0200');
                    lastBtn = document.getElementById('last0200');
                } else {
                    firstBtn = document.getElementById(`${tabName}First`);
                    prevBtn = document.getElementById(`${tabName}Prev`);
                    nextBtn = document.getElementById(`${tabName}Next`);
                    lastBtn = document.getElementById(`${tabName}Last`);
                }

                if (firstBtn) firstBtn.disabled = state.currentPage === 1;
                if (prevBtn) prevBtn.disabled = state.currentPage === 1;
                if (nextBtn) nextBtn.disabled = state.currentPage === state.totalPages;
                if (lastBtn) lastBtn.disabled = state.currentPage === state.totalPages;
            }

            function setupPagination(tabName, dataArray) {
                const state = paginationState[tabName];
                state.totalPages = Math.ceil(dataArray.length / state.pageSize);
                state.currentPage = 1;
                
                let paginationElement;
                if (tabName === '0200') {
                    paginationElement = document.getElementById('pagination0200');
                } else if (tabName === 'empresas') {
                    paginationElement = document.getElementById('empresasPagination');
                } else {
                    paginationElement = document.getElementById(`${tabName}Pagination`);
                }
                
                if (paginationElement) {
                    if (state.totalPages > 1) {
                        paginationElement.style.display = 'flex';
                        updatePaginationInfo(tabName);
                    } else {
                        paginationElement.style.display = 'none';
                    }
                }
            }

            function getPaginatedData(tabName, dataArray) {
                const state = paginationState[tabName];
                const start = (state.currentPage - 1) * state.pageSize;
                const end = start + state.pageSize;
                return dataArray.slice(start, end);
            }

            // FUNÃÃO MELHORADA: Extrair CNPJ e NOME do arquivo SPED com normalizaÃ§Ã£o
            function extractEmpresaFromSped(content) {
                const lines = content.split('\n');
                let cnpj = 'NÃ£o identificado';
                let nome = 'NÃ£o identificado';
                let found = false;
                
                for (const line of lines) {
                    if (line.startsWith('|0000|')) {
                        const fields = line.split('|');
                        // Campo 6 do registro 0000 Ã© o CNPJ
                        if (fields.length > 6 && fields[6] && fields[6].trim() !== '') {
                            cnpj = normalizeCnpj(fields[6].trim());
                        }
                        // Campo 7 do registro 0000 Ã© o NOME
                        if (fields.length > 7 && fields[7] && fields[7].trim() !== '') {
                            nome = normalizeEmpresaName(fields[7].trim());
                        }
                        found = true;
                        break;
                    }
                    
                    // TambÃ©m verifica no registro 0005 (dados complementares)
                    if (line.startsWith('|0005|')) {
                        const fields = line.split('|');
                        // Campo 2 do registro 0005 Ã© o NOME FANTASIA
                        if (fields.length > 2 && fields[2] && fields[2].trim() !== '' && nome === 'NÃ£o identificado') {
                            nome = normalizeEmpresaName(fields[2].trim());
                        }
                    }
                }
                
                // Se nÃ£o encontrou registro 0000, tenta encontrar por outros meios
                if (!found) {
                    for (const line of lines) {
                        if (line.includes('CNPJ') || line.includes('CPF')) {
                            const cnpjMatch = line.match(/\d{2}\.\d{3}\.\d{3}\/\d{4}-\d{2}/) || line.match(/\d{14}/);
                            if (cnpjMatch) {
                                cnpj = normalizeCnpj(cnpjMatch[0]);
                            }
                        }
                        if (line.includes('NOME') || line.includes('RAZAO')) {
                            const nomeMatch = line.split('|').find(part => part.length > 10 && !part.match(/^\d/));
                            if (nomeMatch && nome === 'NÃ£o identificado') {
                                nome = normalizeEmpresaName(nomeMatch);
                            }
                        }
                    }
                }
                
                return { cnpj, nome, key: `${cnpj}|${nome}` };
            }

            function handleFiles(fileList) {
                performanceWarning.style.display = fileList.length > PERFORMANCE_CONFIG.MAX_FILES_WARNING ? 'block' : 'none';
                
                for (let i = 0; i < fileList.length; i++) {
                    const file = fileList[i];
                    
                    // Verificar tamanho do arquivo
                    const fileSizeMB = file.size / (1024 * 1024);
                    if (fileSizeMB > PERFORMANCE_CONFIG.MAX_FILE_SIZE_MB) {
                        addFileToList(file.name, false, `Arquivo muito grande (${fileSizeMB.toFixed(1)} MB)`);
                        continue;
                    }
                    
                    if (!file.type.includes('text/') && !file.name.endsWith('.txt')) {
                        addFileToList(file.name, false, 'Tipo de arquivo nÃ£o suportado');
                        continue;
                    }
                    if (filesData.some(f => f.name === file.name)) {
                        addFileToList(file.name, false, 'Arquivo duplicado');
                        continue;
                    }
                    addFileToList(file.name, true);
                    filesData.push(file);
                    totalFilesSize += file.size;
                }
                updateFileCount();
                processBtn.disabled = filesData.length === 0;
            }
            
            function addFileToList(fileName, success, errorMessage = '') {
                const fileItem = document.createElement('div');
                fileItem.className = `file-item ${success ? 'success' : 'error'}`;
                fileItem.innerHTML = success ? 
                    `<span>${fileName}</span><span class="status-indicator status-success">â Pronto</span>` :
                    `<span>${fileName}</span><span class="status-indicator status-error">â ${errorMessage}</span>`;
                fileList.appendChild(fileItem);
            }
            
            function updateFileCount() {
                fileCount.textContent = `${filesData.length} arquivo(s)`;
                const totalSizeMB = (totalFilesSize / (1024 * 1024)).toFixed(1);
                totalSize.textContent = `${totalSizeMB} MB`;
            }
            
            function clearFiles() {
                filesData = [];
                fileList.innerHTML = '';
                updateFileCount();
                processBtn.disabled = true;
                performanceWarning.style.display = 'none';
                empresaMap.clear();
                totalFilesSize = 0;
            }
            
            // PROCESSAMENTO OTIMIZADO PARA GRANDES VOLUMES
            async function processFiles() {
                if (filesData.length === 0 || isProcessing) return;
                
                isProcessing = true;
                resetAnalysis();
                
                loading.style.display = 'block';
                batchProcessing.style.display = 'block';
                backgroundProcessing.style.display = 'flex';
                processBtn.disabled = true;
                error.style.display = 'none';
                
                // Mostrar informaÃ§Ãµes de otimizaÃ§Ã£o
                if (optimizedMode) {
                    compressionInfo.style.display = 'block';
                    compressionText.textContent = `Processando ${filesData.length} arquivos (${(totalFilesSize / (1024 * 1024)).toFixed(1)} MB) em modo otimizado...`;
                }
                
                try {
                    const results = await processFilesOptimized();
                    analysisData = results;
                    
                    // CORREÃÃO: Usar clone otimizado
                    filteredData = cloneObjectOptimized(results);
                    
                    displayResults(results);
                    resultsSection.style.display = 'block';
                    
                } catch (err) {
                    console.error('Erro no processamento:', err);
                    showError(`Erro durante o processamento: ${err.message}`);
                } finally {
                    loading.style.display = 'none';
                    batchProcessing.style.display = 'none';
                    backgroundProcessing.style.display = 'none';
                    compressionInfo.style.display = 'none';
                    isProcessing = false;
                    processBtn.disabled = false;
                }
            }

            // CORREÃÃO: FunÃ§Ã£o para clonar objetos de forma otimizada
            function cloneObjectOptimized(obj) {
                if (obj === null || typeof obj !== 'object') return obj;
                if (obj instanceof Map) return new Map(obj);
                if (obj instanceof Set) return new Set(obj);
                
                const cloned = Array.isArray(obj) ? [] : {};
                for (const key in obj) {
                    if (obj.hasOwnProperty(key)) {
                        cloned[key] = cloneObjectOptimized(obj[key]);
                    }
                }
                return cloned;
            }

            // PROCESSAMENTO OTIMIZADO COM SUPORTE A GRANDES ARQUIVOS
            async function processFilesOptimized() {
                const totalFiles = filesData.length;
                let processedCount = 0;
                
                const allResults = {
                    periodos: new Map(),
                    registros: new Map(),
                    filesData: [],
                    empresas: new Map(), // Mapa de empresas normalizado
                    totalRegistros: 0,
                    totalValor: 0,
                    recordTypes: new Set()
                };

                // Processar em lotes menores para arquivos grandes
                const actualBatchSize = optimizedMode ? PERFORMANCE_CONFIG.BATCH_SIZE : Math.min(PERFORMANCE_CONFIG.BATCH_SIZE, 10);
                
                for (let i = 0; i < totalFiles; i += actualBatchSize) {
                    const batch = Array.from(filesData).slice(i, i + actualBatchSize);
                    
                    // Atualizar progresso
                    processedCount += batch.length;
                    const progress = Math.round((processedCount / totalFiles) * 100);
                    batchProgressBar.style.width = `${progress}%`;
                    batchProgressText.textContent = `${progress}%`;
                    currentFile.textContent = `Processando: ${processedCount} de ${totalFiles} arquivos`;
                    
                    // Processar lote atual
                    for (const file of batch) {
                        try {
                            const content = await readFileAsync(file);
                            const empresa = extractEmpresaFromSped(content);
                            empresaMap.set(file.name, empresa);
                            
                            // CORREÃÃO: Usar chave normalizada para empresas
                            const empresaKey = empresa.key;
                            if (!allResults.empresas.has(empresaKey)) {
                                allResults.empresas.set(empresaKey, {
                                    cnpj: empresa.cnpj,
                                    nome: empresa.nome,
                                    arquivos: new Set(),
                                    periodos: new Set(),
                                    totalRegistros: 0,
                                    totalValor: 0,
                                    items0200: 0,
                                    registrosC170: 0
                                });
                            }
                            
                            const fileAnalysis = analyzeSpedFile(content, file.name, empresa);
                            allResults.filesData.push({
                                fileName: file.name,
                                empresa: empresa,
                                ...fileAnalysis
                            });
                            
                            processByPeriodo(allResults, fileAnalysis, file.name, empresa);
                            
                        } catch (err) {
                            console.error(`Erro ao processar ${file.name}:`, err);
                            allResults.filesData.push({
                                fileName: file.name,
                                empresa: { cnpj: 'Erro', nome: 'Erro', key: 'Erro|Erro' },
                                error: err.message,
                                periodo: null,
                                allRecords: [],
                                items0200: new Map(),
                                registrosC170: [],
                                totalRegistros: 0,
                                totalValor: 0
                            });
                        }
                    }
                    
                    // Liberar memÃ³ria e permitir que a interface responda
                    if (optimizedMode) {
                        await new Promise(resolve => {
                            setTimeout(() => {
                                if (typeof gc !== 'undefined') gc(); // ForÃ§ar garbage collection se disponÃ­vel
                                resolve();
                            }, 100);
                        });
                    } else {
                        await new Promise(resolve => setTimeout(resolve, 0));
                    }
                    
                    // Atualizar uso de memÃ³ria
                    updateMemoryUsage();
                }
                
                return allResults;
            }

            // FUNÃÃO MELHORADA: Leitura de arquivo com tratamento de erros
            function readFileAsync(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = e => resolve(e.target.result);
                    reader.onerror = () => reject(new Error(`Erro ao ler arquivo: ${file.name}`));
                    reader.onabort = () => reject(new Error(`Leitura abortada: ${file.name}`));
                    
                    try {
                        reader.readAsText(file, 'ISO-8859-1');
                    } catch (error) {
                        reject(new Error(`Erro ao processar arquivo ${file.name}: ${error.message}`));
                    }
                });
            }

            // FUNÃÃO MELHORADA: AnÃ¡lise do arquivo SPED com otimizaÃ§Ãµes
            function analyzeSpedFile(content, fileName, empresa) {
                const lines = content.split('\n');
                let periodo = null;
                let allRecords = [];
                const items0200 = new Map();
                const registrosC170 = [];
                
                // OtimizaÃ§Ã£o: processar linhas em chunks para nÃ£o travar
                const processChunk = (start, end) => {
                    for (let i = start; i < end && i < lines.length; i++) {
                        const line = lines[i];
                        if (!line.trim()) continue;
                        
                        const parts = line.split('|').filter(part => part !== '');
                        if (parts.length < 2) continue;
                        
                        const registro = parts[0];
                        
                        if (registro === '0000' && parts.length >= 5) {
                            const dataInicio = parts[3];
                            if (dataInicio && dataInicio.length === 8) {
                                periodo = {
                                    dataInicio: `${dataInicio.substring(0,2)}/${dataInicio.substring(2,4)}/${dataInicio.substring(4,8)}`,
                                    dataFim: `${parts[4].substring(0,2)}/${parts[4].substring(2,4)}/${parts[4].substring(4,8)}`,
                                    mes: dataInicio.substring(2,4),
                                    ano: dataInicio.substring(4,8)
                                };
                            }
                        }
                        else if (registro === '0200' && parts.length >= 3) {
                            const itemData = {
                                arquivo: fileName,
                                empresa: empresa,
                                periodo: periodo,
                                codigo: parts[1],
                                descricao: parts[2],
                                codBarras: parts[3] || '',
                                unidade: parts[5] || '',
                                tipoItem: parts[6] || '',
                                codNCM: parts[7] || ''
                            };
                            items0200.set(parts[1], itemData);
                            
                            allRecords.push({
                                fileName,
                                empresa: empresa,
                                registro: '0200',
                                itemCodigo: parts[1],
                                itemDescricao: parts[2],
                                valor: 0,
                                data: '',
                                linha: line.substring(0, 200), // Limitar tamanho para economizar memÃ³ria
                                periodo: periodo
                            });
                        }
                        else if (registro === 'C170' && parts.length >= 8) {
                            const c170Data = {
                                arquivo: fileName,
                                empresa: empresa,
                                periodo: periodo,
                                numItem: parts[1] || '',
                                codItem: parts[2] || '',
                                descricaoCompl: parts[3] || '',
                                qtd: parseValorSPED(parts[4]),
                                unid: parts[5] || '',
                                vlItem: parseValorSPED(parts[6]),
                                vlDesc: parseValorSPED(parts[7]),
                                vlBaseICMS: parseValorSPED(parts[12]),
                                vlICMS: parseValorSPED(parts[14])
                            };
                            registrosC170.push(c170Data);
                            
                            allRecords.push({
                                fileName,
                                empresa: empresa,
                                registro: 'C170',
                                itemCodigo: parts[2],
                                itemDescricao: '',
                                valor: c170Data.vlItem,
                                data: '',
                                linha: line.substring(0, 200), // Limitar tamanho
                                periodo: periodo
                            });
                        }
                        else if (isRegistroComValor(registro)) {
                            const valor = extractValorFromRegistro(registro, parts);
                            const recordData = {
                                fileName,
                                empresa: empresa,
                                registro,
                                itemCodigo: '',
                                itemDescricao: '',
                                valor: valor,
                                data: extractDataFromRegistro(registro, parts),
                                linha: line.substring(0, 200), // Limitar tamanho
                                periodo: periodo
                            };
                            
                            allRecords.push(recordData);
                        }
                    }
                };
                
                // Processar em chunks para nÃ£o travar a UI
                const CHUNK_SIZE = 1000;
                for (let i = 0; i < lines.length; i += CHUNK_SIZE) {
                    processChunk(i, i + CHUNK_SIZE);
                }
                
                return {
                    periodo,
                    allRecords,
                    items0200,
                    registrosC170,
                    totalRegistros: allRecords.length,
                    totalValor: allRecords.reduce((sum, record) => sum + record.valor, 0)
                };
            }

            // FUNÃÃO MELHORADA: Processar por perÃ­odo com empresa normalizada
            function processByPeriodo(allResults, fileAnalysis, fileName, empresa) {
                const periodoKey = fileAnalysis.periodo ? 
                    `${fileAnalysis.periodo.ano}-${fileAnalysis.periodo.mes}` : 'sem-periodo';
                
                if (!allResults.periodos.has(periodoKey)) {
                    allResults.periodos.set(periodoKey, {
                        ano: fileAnalysis.periodo?.ano || 'N/A',
                        mes: fileAnalysis.periodo?.mes || 'N/A',
                        descricao: fileAnalysis.periodo ? 
                            `${fileAnalysis.periodo.mes}/${fileAnalysis.periodo.ano}` : 'Sem perÃ­odo',
                        arquivos: new Set(),
                        empresas: new Set(), // Usar chaves normalizadas
                        registros: [],
                        items0200: new Map(),
                        registrosC170: [],
                        totalRegistros: 0,
                        totalValor: 0,
                        recordTypes: new Set()
                    });
                }
                
                const periodo = allResults.periodos.get(periodoKey);
                periodo.arquivos.add(fileName);
                periodo.empresas.add(empresa.key); // Usar chave normalizada
                
                // Atualizar dados da empresa usando chave normalizada
                if (allResults.empresas.has(empresa.key)) {
                    const empresaData = allResults.empresas.get(empresa.key);
                    empresaData.arquivos.add(fileName);
                    empresaData.periodos.add(periodoKey);
                    empresaData.totalRegistros += fileAnalysis.totalRegistros;
                    empresaData.totalValor += fileAnalysis.totalValor;
                    empresaData.items0200 += fileAnalysis.items0200.size;
                    empresaData.registrosC170 += fileAnalysis.registrosC170.length;
                }
                
                fileAnalysis.allRecords.forEach(record => {
                    periodo.registros.push(record);
                    periodo.totalRegistros++;
                    periodo.totalValor += record.valor;
                    periodo.recordTypes.add(record.registro);
                    
                    allResults.totalRegistros++;
                    allResults.totalValor += record.valor;
                    allResults.recordTypes.add(record.registro);
                    
                    if (!allResults.registros.has(record.registro)) {
                        allResults.registros.set(record.registro, {
                            registro: record.registro,
                            count: 0,
                            total: 0,
                            periodos: new Set(),
                            arquivos: new Set(),
                            empresas: new Set() // Usar chaves normalizadas
                        });
                    }
                    const registroData = allResults.registros.get(record.registro);
                    registroData.count++;
                    registroData.total += record.valor;
                    registroData.periodos.add(periodoKey);
                    registroData.arquivos.add(fileName);
                    registroData.empresas.add(empresa.key); // Usar chave normalizada
                });
                
                fileAnalysis.items0200.forEach((item, codigo) => {
                    periodo.items0200.set(codigo, item);
                });
                
                periodo.registrosC170.push(...fileAnalysis.registrosC170);
            }

            // FUNÃÃES EXISTENTES MANTIDAS (parseValorSPED, extractValorFromRegistro, etc.)
            function parseValorSPED(valorStr) {
                if (!valorStr || valorStr === '' || valorStr === undefined) return 0;
                valorStr = valorStr.trim();
                if (valorStr === '') return 0;
                
                try {
                    let valorLimpo = valorStr.replace(/[^\d,.-]/g, '');
                    
                    if (!valorLimpo.includes(',') && !valorLimpo.includes('.')) {
                        return parseFloat(valorLimpo) || 0;
                    }
                    
                    if (valorLimpo.includes(',') && valorLimpo.lastIndexOf(',') > valorLimpo.lastIndexOf('.')) {
                        valorLimpo = valorLimpo.replace(/\./g, '').replace(',', '.');
                    }
                    else if (valorLimpo.includes('.') && valorLimpo.lastIndexOf('.') > valorLimpo.lastIndexOf(',')) {
                        valorLimpo = valorLimpo.replace(/,/g, '');
                    }
                    
                    const valorNumerico = parseFloat(valorLimpo);
                    
                    if (isNaN(valorNumerico)) {
                        return 0;
                    }
                    
                    if (Math.abs(valorNumerico) > 1000000000) {
                        const valorCorrigido = valorNumerico / 100;
                        if (Math.abs(valorCorrigido) < 1000000000) {
                            return valorCorrigido;
                        }
                        return 0;
                    }
                    
                    return valorNumerico;
                    
                } catch (error) {
                    return 0;
                }
            }

            function extractValorFromRegistro(registro, parts) {
                let valor = 0;
                
                const camposValor = {
                    'C100': 10, 'C170': 6, 'C190': 5, 'C191': 3, 'C195': 3, 'C197': 3,
                    'C500': 5, 'C590': 5, 'D100': 7, 'D190': 5, 'D500': 5, 'D590': 5,
                    'E110': 2, 'E116': 3, 'E210': 2, 'E310': 2
                };
                
                if (registro === 'D100' && parts.length > 7) {
                    const campoValor = parts[7];
                    if (campoValor && campoValor.trim() !== '') {
                        valor = parseValorSPED(campoValor);
                    }
                }
                else if (camposValor[registro] !== undefined && parts.length > camposValor[registro]) {
                    const campoValor = parts[camposValor[registro]];
                    if (campoValor && campoValor.trim() !== '') {
                        valor = parseValorSPED(campoValor);
                    }
                } else {
                    for (let i = 1; i < parts.length; i++) {
                        const part = parts[i];
                        if (part && part.trim() !== '') {
                            if (part.includes(',') || (!isNaN(part) && part.includes('.')) || 
                                (part.replace(',', '.').replace(/[^0-9.-]/g, '') !== '')) {
                                
                                const potentialValor = parseValorSPED(part);
                                if (potentialValor !== 0 && Math.abs(potentialValor) < 1000000000) {
                                    valor = potentialValor;
                                    break;
                                }
                            }
                        }
                    }
                }
                
                if (!isFinite(valor) || Math.abs(valor) > 1e12) {
                    valor = 0;
                }
                
                return valor;
            }
            
            function isRegistroComValor(registro) {
                const registrosComValor = [
                    'C100', 'C101', 'C105', 'C110', 'C111', 'C112', 'C113', 'C114', 'C115', 'C116', 'C120', 
                    'C130', 'C140', 'C141', 'C160', 'C165', 'C170', 'C171', 'C172', 'C173', 'C174', 'C175', 
                    'C176', 'C177', 'C178', 'C179', 'C190', 'C191', 'C195', 'C197', 'C300', 'C310', 'C320', 
                    'C321', 'C350', 'C370', 'C390', 'C400', 'C405', 'C410', 'C420', 'C425', 'C430', 'C440', 
                    'C460', 'C470', 'C490', 'C500', 'C510', 'C590', 'C600', 'C601', 'C610', 'C690', 'C700', 
                    'C790', 'C791', 'C800', 'C850', 'C860', 'C890', 'C895', 'D100', 'D101', 'D105', 'D110', 
                    'D111', 'D112', 'D113', 'D114', 'D115', 'D116', 'D120', 'D130', 'D140', 'D150', 'D190', 
                    'D195', 'D197', 'D300', 'D301', 'D310', 'D350', 'D355', 'D360', 'D365', 'D370', 'D390', 
                    'D400', 'D410', 'D411', 'D420', 'D500', 'D510', 'D590', 'D600', 'D610', 'D690', 'D695', 
                    'D696', 'D697', 'E100', 'E110', 'E111', 'E112', 'E113', 'E115', 'E116', 'E200', 'E210', 
                    'E220', 'E230', 'E240', 'E250', 'E500', 'E510', 'E520', 'E530', 'E990'
                ];
                
                return registrosComValor.includes(registro) || 
                       registro.startsWith('C') || 
                       registro.startsWith('D') || 
                       registro.startsWith('E');
            }
            
            function extractDataFromRegistro(registro, parts) {
                switch (registro) {
                    case 'C100': 
                        if (parts.length > 8 && parts[8] && parts[8].length === 8) {
                            const data = parts[8];
                            return `${data.substring(0,2)}/${data.substring(2,4)}/${data.substring(4,8)}`;
                        }
                        return '';
                    case 'D100': 
                        if (parts.length > 6 && parts[6] && parts[6].length === 8) {
                            const data = parts[6];
                            return `${data.substring(0,2)}/${data.substring(2,4)}/${data.substring(4,8)}`;
                        }
                        return '';
                    default: 
                        return '';
                }
            }

            function consolidateResults(allResults) {
                const totalValorValido = validarValores(allResults);
                allResults.totalValor = totalValorValido;
                
                allResults.periodos.forEach((periodo, periodoKey) => {
                    const itemsComValores = new Map();
                    
                    periodo.registrosC170.forEach(c170 => {
                        if (c170.codItem) {
                            const item0200 = periodo.items0200.get(c170.codItem);
                            const itemKey = `${c170.codItem}|${periodoKey}`;
                            
                            if (!itemsComValores.has(itemKey)) {
                                itemsComValores.set(itemKey, {
                                    codigo: c170.codItem,
                                    descricao: item0200 ? item0200.descricao : 'NÃ£o cadastrado',
                                    unidade: item0200 ? item0200.unidade : c170.unid,
                                    periodo: periodo.descricao,
                                    quantidadeTotal: 0,
                                    valorTotal: 0,
                                    registrosC170: [],
                                    arquivos: new Set(),
                                    empresas: new Set() // Usar chaves normalizadas
                                });
                            }
                            
                            const item = itemsComValores.get(itemKey);
                            item.quantidadeTotal += c170.qtd;
                            item.valorTotal += c170.vlItem;
                            item.registrosC170.push(c170);
                            item.arquivos.add(c170.arquivo);
                            item.empresas.add(c170.empresa.key); // Usar chave normalizada
                        }
                    });
                    
                    periodo.itemsComValores = itemsComValores;
                    periodo.totalValor = periodo.registros.reduce((sum, record) => sum + record.valor, 0);
                });
                
                return allResults;
            }

            function validarValores(data) {
                let totalValor = 0;
                
                data.periodos.forEach((periodo, periodoKey) => {
                    periodo.registros.forEach(record => {
                        if (!isFinite(record.valor) || 
                            record.valor > 1e12 || 
                            record.valor < -1e12 ||
                            (record.registro === 'D100' && record.valor > 1000000000)) {
                            record.valor = 0;
                        } else {
                            totalValor += record.valor;
                        }
                    });
                });
                
                return totalValor;
            }

            function displayResults(data) {
                data = consolidateResults(data);
                
                processedFiles.textContent = data.filesData.length;
                totalPeriodos.textContent = data.periodos.size;
                totalRegistros.textContent = data.totalRegistros;
                totalEmpresas.textContent = data.empresas.size;
                
                // CORREÃÃO: Atualizar Total Geral do Montante
                totalMontante.textContent = `R$ ${data.totalValor.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                
                updateFilters(data);
                updateDebugInfo(data);
                
                const totalRecords = data.totalRegistros;
                if (totalRecords > PERFORMANCE_CONFIG.VIRTUAL_SCROLL_THRESHOLD) {
                    Object.keys(paginationState).forEach(tab => {
                        paginationState[tab].pageSize = PERFORMANCE_CONFIG.PAGE_SIZE;
                    });
                }
                
                displayPeriodoTable(data);
                displayRegistrosTable(data);
                displayItensTable(data);
                displayC170Table(data);
                display0200Table(data);
                displayDetailsTable(data);
                displayFilesTable(data);
                displayEmpresasTable(data);
            }
            
            // FUNÃÃES DE EXIBIÃÃO ATUALIZADAS
            function displayPeriodoTable(data) {
                const periodosArray = Array.from(data.periodos.values()).sort((a, b) => {
                    if (a.ano === 'N/A') return 1;
                    if (b.ano === 'N/A') return -1;
                    return `${a.ano}${a.mes}`.localeCompare(`${b.ano}${b.mes}`);
                });
                
                setupPagination('periodo', periodosArray);
                const paginatedData = getPaginatedData('periodo', periodosArray);
                
                periodoTableBody.innerHTML = '';
                let globalTotal = 0;
                
                paginatedData.forEach(periodo => {
                    const totalC170 = periodo.registrosC170.reduce((sum, c170) => sum + c170.vlItem, 0);
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><span class="periodo-badge">${periodo.descricao}</span></td>
                        <td>${periodo.arquivos.size}</td>
                        <td>${periodo.empresas.size}</td>
                        <td>${periodo.totalRegistros}</td>
                        <td>${Array.from(periodo.recordTypes).sort().join(', ')}</td>
                        <td class="valor-cell">R$ ${periodo.totalValor.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td>${periodo.items0200.size}</td>
                        <td>${periodo.registrosC170.length}</td>
                        <td class="valor-cell">R$ ${totalC170.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    `;
                    periodoTableBody.appendChild(row);
                    globalTotal += periodo.totalValor;
                });
                
                if (paginationState.periodo.currentPage === paginationState.periodo.totalPages || paginationState.periodo.totalPages === 1) {
                    const totalRow = document.createElement('tr');
                    totalRow.className = 'total-row';
                    totalRow.innerHTML = `
                        <td><strong>TOTAL GERAL</strong></td>
                        <td>${data.filesData.length}</td>
                        <td>${data.empresas.size}</td>
                        <td>${data.totalRegistros}</td>
                        <td>${data.recordTypes.size} tipos</td>
                        <td class="valor-cell"><strong>R$ ${globalTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong></td>
                        <td>${Array.from(data.periodos.values()).reduce((sum, p) => sum + p.items0200.size, 0)}</td>
                        <td>${Array.from(data.periodos.values()).reduce((sum, p) => sum + p.registrosC170.length, 0)}</td>
                        <td class="valor-cell"><strong>R$ ${Array.from(data.periodos.values()).reduce((sum, p) => sum + p.registrosC170.reduce((s, c) => s + c.vlItem, 0), 0).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong></td>
                    `;
                    periodoTableBody.appendChild(totalRow);
                }
            }
            
            function displayRegistrosTable(data) {
                const registrosArray = Array.from(data.registros.values()).sort((a, b) => b.total - a.total);
                setupPagination('registros', registrosArray);
                const paginatedData = getPaginatedData('registros', registrosArray);
                
                registrosTableBody.innerHTML = '';
                
                paginatedData.forEach(registro => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><span class="registro-badge">${registro.registro}</span></td>
                        <td>${getRegistroDescription(registro.registro)}</td>
                        <td>${registro.count}</td>
                        <td class="valor-cell">R$ ${registro.total.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td>${registro.periodos.size}</td>
                        <td>${registro.arquivos.size}</td>
                        <td>${registro.empresas.size}</td>
                    `;
                    registrosTableBody.appendChild(row);
                });
            }
            
            function displayItensTable(data) {
                const itensArray = [];
                Array.from(data.periodos.values()).forEach(periodo => {
                    periodo.itemsComValores.forEach(item => {
                        itensArray.push(item);
                    });
                });
                
                setupPagination('itens', itensArray);
                const paginatedData = getPaginatedData('itens', itensArray);
                
                itensTableBody.innerHTML = '';
                
                paginatedData.forEach(item => {
                    const valorUnitarioMedio = item.quantidadeTotal > 0 ? item.valorTotal / item.quantidadeTotal : 0;
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>${item.codigo}</strong></td>
                        <td>${item.descricao}</td>
                        <td>${item.unidade}</td>
                        <td class="periodo-column"><span class="periodo-badge">${item.periodo}</span></td>
                        <td>${item.quantidadeTotal.toLocaleString('pt-BR', {minimumFractionDigits: 3, maximumFractionDigits: 3})}</td>
                        <td class="valor-cell">R$ ${item.valorTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td>R$ ${valorUnitarioMedio.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td>${item.registrosC170.length}</td>
                        <td>${item.arquivos.size}</td>
                        <td>${item.empresas.size}</td>
                    `;
                    itensTableBody.appendChild(row);
                });
            }
            
            function displayC170Table(data) {
                const c170Array = [];
                Array.from(data.periodos.values()).forEach(periodo => {
                    periodo.registrosC170.forEach(c170 => {
                        c170Array.push({...c170, periodoDesc: periodo.descricao});
                    });
                });
                
                setupPagination('c170', c170Array);
                const paginatedData = getPaginatedData('c170', c170Array);
                
                c170TableBody.innerHTML = '';
                
                paginatedData.forEach(c170 => {
                    const periodo = Array.from(data.periodos.values()).find(p => p.descricao === c170.periodoDesc);
                    const item0200 = periodo ? periodo.items0200.get(c170.codItem) : null;
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="periodo-column"><span class="periodo-badge">${c170.periodoDesc}</span></td>
                        <td>${c170.arquivo}</td>
                        <td>
                            <div class="empresa-info">
                                <div class="empresa-nome">${c170.empresa.nome}</div>
                                <div class="empresa-cnpj">${formatCnpjDisplay(c170.empresa.cnpj)}</div>
                            </div>
                        </td>
                        <td><strong>${c170.codItem}</strong></td>
                        <td>${item0200?.descricao || ''}</td>
                        <td>${c170.descricaoCompl}</td>
                        <td>${c170.qtd.toLocaleString('pt-BR', {minimumFractionDigits: 3, maximumFractionDigits: 3})}</td>
                        <td>${c170.unid}</td>
                        <td class="valor-cell">R$ ${c170.vlItem.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td>R$ ${c170.vlDesc.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td>R$ ${c170.vlBaseICMS.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td>R$ ${c170.vlICMS.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    `;
                    c170TableBody.appendChild(row);
                });
            }
            
            function display0200Table(data) {
                const items0200Array = [];
                Array.from(data.periodos.values()).forEach(periodo => {
                    periodo.items0200.forEach(item => {
                        items0200Array.push({...item, periodoDesc: periodo.descricao});
                    });
                });
                
                setupPagination('0200', items0200Array);
                const paginatedData = getPaginatedData('0200', items0200Array);
                
                table0200Body.innerHTML = '';
                
                paginatedData.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="periodo-column"><span class="periodo-badge">${item.periodoDesc}</span></td>
                        <td>${item.arquivo}</td>
                        <td>
                            <div class="empresa-info">
                                <div class="empresa-nome">${item.empresa.nome}</div>
                                <div class="empresa-cnpj">${formatCnpjDisplay(item.empresa.cnpj)}</div>
                            </div>
                        </td>
                        <td><strong>${item.codigo}</strong></td>
                        <td>${item.descricao}</td>
                        <td>${item.codBarras}</td>
                        <td>${item.unidade}</td>
                        <td>${getTipoItemDescription(item.tipoItem)}</td>
                        <td>${item.codNCM}</td>
                    `;
                    table0200Body.appendChild(row);
                });
            }
            
            function displayDetailsTable(data) {
                const detailsArray = [];
                Array.from(data.periodos.values()).forEach(periodo => {
                    periodo.registros.forEach(record => {
                        detailsArray.push({...record, periodoDesc: periodo.descricao});
                    });
                });
                
                setupPagination('details', detailsArray);
                const paginatedData = getPaginatedData('details', detailsArray);
                
                detailsTableBody.innerHTML = '';
                
                paginatedData.forEach(record => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="periodo-column"><span class="periodo-badge">${record.periodoDesc}</span></td>
                        <td>${record.fileName}</td>
                        <td>
                            <div class="empresa-info">
                                <div class="empresa-nome">${record.empresa.nome}</div>
                                <div class="empresa-cnpj">${formatCnpjDisplay(record.empresa.cnpj)}</div>
                            </div>
                        </td>
                        <td><span class="registro-badge">${record.registro}</span></td>
                        <td>${record.itemCodigo}</td>
                        <td>${record.itemDescricao}</td>
                        <td class="valor-cell">R$ ${record.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td>${record.data}</td>
                        <td><small>${record.linha.substring(0, 100)}...</small></td>
                    `;
                    detailsTableBody.appendChild(row);
                });
            }
            
            function displayFilesTable(data) {
                const filesArray = data.filesData;
                setupPagination('files', filesArray);
                const paginatedData = getPaginatedData('files', filesArray);
                
                filesTableBody.innerHTML = '';
                
                paginatedData.forEach(file => {
                    const periodo = file.periodo;
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${file.fileName}</td>
                        <td>
                            <div class="empresa-info">
                                <div class="empresa-nome">${file.empresa.nome}</div>
                                <div class="empresa-cnpj">${formatCnpjDisplay(file.empresa.cnpj)}</div>
                            </div>
                        </td>
                        <td>${periodo ? `${periodo.dataInicio} a ${periodo.dataFim}` : 'NÃ£o identificado'}</td>
                        <td>${periodo ? `${periodo.mes}/${periodo.ano}` : 'N/A'}</td>
                        <td>${file.totalRegistros}</td>
                        <td>${Array.from(new Set(file.allRecords.map(r => r.registro))).join(', ')}</td>
                        <td class="valor-cell">R$ ${file.totalValor.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td>${file.items0200.size}</td>
                        <td>${file.registrosC170.length}</td>
                    `;
                    filesTableBody.appendChild(row);
                });
            }

            // FUNÃÃO MELHORADA: Exibir tabela de empresas
            function displayEmpresasTable(data) {
                const empresasArray = Array.from(data.empresas.values()).sort((a, b) => 
                    a.nome.localeCompare(b.nome)
                );
                
                setupPagination('empresas', empresasArray);
                const paginatedData = getPaginatedData('empresas', empresasArray);
                
                empresasTableBody.innerHTML = '';
                
                paginatedData.forEach(empresa => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><span class="cnpj-badge">${formatCnpjDisplay(empresa.cnpj)}</span></td>
                        <td><strong>${empresa.nome}</strong></td>
                        <td>${empresa.arquivos.size}</td>
                        <td>${empresa.periodos.size}</td>
                        <td>${empresa.totalRegistros}</td>
                        <td class="valor-cell">R$ ${empresa.totalValor.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td>${empresa.items0200}</td>
                        <td>${empresa.registrosC170}</td>
                    `;
                    empresasTableBody.appendChild(row);
                });
            }

            // FUNÃÃO MELHORADA: Formatar CNPJ para exibiÃ§Ã£o
            function formatCnpjDisplay(cnpj) {
                if (!cnpj || cnpj === 'NÃ£o identificado' || cnpj === 'Erro') return cnpj;
                
                const cnpjLimpo = cnpj.replace(/\D/g, '');
                if (cnpjLimpo.length === 14) {
                    return cnpjLimpo.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
                }
                return cnpj;
            }

            // FUNÃÃO MELHORADA: Aplicar Filtros com Empresa normalizada
            function applyFilters() {
                if (!analysisData) return;
                
                const empresaFiltro = filterEmpresa.value.trim().toLowerCase();
                const anoFiltro = filterAno.value;
                const mesFiltro = filterMes.value;
                const registroFiltro = filterRegistro.value;
                const itemCodigoFiltro = filterItemCodigo.value.trim().toUpperCase();
                const itemDescricaoFiltro = filterItemDescricao.value.trim().toLowerCase();
                const valorMinFiltro = parseFloat(filterValorMin.value) || 0;
                const valorMaxFiltro = parseFloat(filterValorMax.value) || Infinity;
                
                // CORREÃÃO: Usar clone otimizado
                filteredData = cloneObjectOptimized(analysisData);
                
                // Aplicar filtro de Empresa (CNPJ ou Nome)
                if (empresaFiltro) {
                    filteredData.periodos.forEach((periodo, periodoKey) => {
                        // Filtrar arquivos por empresa
                        const arquivosFiltrados = Array.from(periodo.arquivos).filter(arquivo => {
                            const empresa = empresaMap.get(arquivo);
                            if (!empresa) return false;
                            
                            // Buscar tanto no CNPJ quanto no Nome (normalizados)
                            return empresa.cnpj.includes(empresaFiltro) || 
                                   empresa.nome.toLowerCase().includes(empresaFiltro);
                        });
                        
                        if (arquivosFiltrados.length === 0) {
                            filteredData.periodos.delete(periodoKey);
                            return;
                        }
                        
                        // Atualizar arquivos do perÃ­odo
                        periodo.arquivos = new Set(arquivosFiltrados);
                        
                        // Filtrar registros por arquivo
                        periodo.registros = periodo.registros.filter(record => 
                            arquivosFiltrados.includes(record.fileName)
                        );
                        
                        // Filtrar registros C170
                        periodo.registrosC170 = periodo.registrosC170.filter(c170 => 
                            arquivosFiltrados.includes(c170.arquivo)
                        );
                        
                        // Atualizar empresas do perÃ­odo
                        periodo.empresas = new Set();
                        arquivosFiltrados.forEach(arquivo => {
                            const empresa = empresaMap.get(arquivo);
                            if (empresa) {
                                periodo.empresas.add(empresa.key);
                            }
                        });
                    });
                }
                
                // Aplicar outros filtros
                filteredData.periodos.forEach((periodo, periodoKey) => {
                    if (anoFiltro && periodo.ano !== anoFiltro) {
                        filteredData.periodos.delete(periodoKey);
                        return;
                    }
                    
                    if (mesFiltro && periodo.mes !== mesFiltro) {
                        filteredData.periodos.delete(periodoKey);
                        return;
                    }
                    
                    // Filtrar registros
                    periodo.registros = periodo.registros.filter(record => {
                        if (registroFiltro && record.registro !== registroFiltro) return false;
                        if (itemCodigoFiltro && record.itemCodigo !== itemCodigoFiltro) return false;
                        if (itemDescricaoFiltro && !record.itemDescricao.toLowerCase().includes(itemDescricaoFiltro)) return false;
                        if (record.valor < valorMinFiltro || record.valor > valorMaxFiltro) return false;
                        return true;
                    });
                    
                    // Filtrar itens 0200
                    periodo.items0200.forEach((item, codigo) => {
                        // Filtro por empresa nos itens 0200
                        if (empresaFiltro) {
                            const arquivosEmpresa = Array.from(periodo.arquivos);
                            if (!arquivosEmpresa.includes(item.arquivo)) {
                                periodo.items0200.delete(codigo);
                            }
                        }
                    });
                    
                    // Filtrar registros C170
                    periodo.registrosC170 = periodo.registrosC170.filter(c170 => {
                        if (itemCodigoFiltro && c170.codItem !== itemCodigoFiltro) return false;
                        if (c170.vlItem < valorMinFiltro || c170.vlItem > valorMaxFiltro) return false;
                        return true;
                    });
                    
                    // Recalcular totais
                    periodo.totalRegistros = periodo.registros.length;
                    periodo.totalValor = periodo.registros.reduce((sum, record) => sum + record.valor, 0);
                    periodo.recordTypes = new Set(periodo.registros.map(r => r.registro));
                });
                
                // Recalcular totais gerais
                filteredData.totalRegistros = Array.from(filteredData.periodos.values())
                    .reduce((sum, periodo) => sum + periodo.totalRegistros, 0);
                filteredData.totalValor = Array.from(filteredData.periodos.values())
                    .reduce((sum, periodo) => sum + periodo.totalValor, 0);
                
                // Recalcular empresas Ãºnicas
                filteredData.empresas = new Map();
                filteredData.periodos.forEach(periodo => {
                    periodo.empresas.forEach(empresaKey => {
                        const empresa = Array.from(analysisData.empresas.values()).find(e => e.key === empresaKey);
                        if (empresa && !filteredData.empresas.has(empresaKey)) {
                            filteredData.empresas.set(empresaKey, {
                                ...empresa,
                                arquivos: new Set(Array.from(empresa.arquivos).filter(arq => {
                                    const emp = empresaMap.get(arq);
                                    return emp && emp.key === empresaKey;
                                })),
                                periodos: new Set(Array.from(empresa.periodos).filter(p => filteredData.periodos.has(p)))
                            });
                        }
                    });
                });
                
                displayResults(filteredData);
            }
            
            function clearFilters() {
                filterEmpresa.value = '';
                filterAno.value = '';
                filterMes.value = '';
                filterRegistro.value = '';
                filterItemCodigo.value = '';
                filterItemDescricao.value = '';
                filterValorMin.value = '';
                filterValorMax.value = '';
                
                if (analysisData) {
                    // CORREÃÃO: Usar clone otimizado
                    filteredData = cloneObjectOptimized(analysisData);
                    displayResults(filteredData);
                }
            }
            
            function validateValorFilters() {
                const valorMin = parseFloat(filterValorMin.value);
                const valorMax = parseFloat(filterValorMax.value);
                
                if (valorMin > 0 && valorMax > 0 && valorMin > valorMax) {
                    filterValorMin.setCustomValidity('Valor mÃ­nimo nÃ£o pode ser maior que o mÃ¡ximo');
                    filterValorMin.style.borderColor = 'var(--accent-color)';
                    filterValorMax.style.borderColor = 'var(--accent-color)';
                } else {
                    filterValorMin.setCustomValidity('');
                    filterValorMin.style.borderColor = '';
                    filterValorMax.style.borderColor = '';
                }
            }
            
            function togglePeriodoViewHandler() {
                periodoView = !periodoView;
                togglePeriodoView.textContent = periodoView ? 'Vista Consolidada' : 'Vista por PerÃ­odo';
                
                const tables = document.querySelectorAll('#itensTab, #c170Tab, #tab0200, #detailsTab');
                tables.forEach(table => {
                    if (periodoView) {
                        table.classList.remove('view-consolidada');
                    } else {
                        table.classList.add('view-consolidada');
                    }
                });
                
                if (filteredData) {
                    displayItensTable(filteredData);
                    displayC170Table(filteredData);
                    display0200Table(filteredData);
                    displayDetailsTable(filteredData);
                }
            }
            
            function updateFilters(data) {
                const anos = new Set();
                data.periodos.forEach(periodo => {
                    if (periodo.ano !== 'N/A') anos.add(periodo.ano);
                });
                
                filterAno.innerHTML = '<option value="">Todos os anos</option>';
                Array.from(anos).sort().reverse().forEach(ano => {
                    const option = document.createElement('option');
                    option.value = ano;
                    option.textContent = ano;
                    filterAno.appendChild(option);
                });
                
                filterRegistro.innerHTML = '<option value="">Todos os registros</option>';
                Array.from(data.recordTypes).sort().forEach(registro => {
                    const option = document.createElement('option');
                    option.value = registro;
                    option.textContent = `${registro} - ${getRegistroDescription(registro)}`;
                    filterRegistro.appendChild(option);
                });
            }
            
            function updateDebugInfo(data) {
                if (!debugMode) return;
                
                let debugHTML = `
                    <div><strong>Arquivos Processados:</strong> ${data.filesData.length}</div>
                    <div><strong>PerÃ­odos Encontrados:</strong> ${data.periodos.size}</div>
                    <div><strong>Total de Registros:</strong> ${data.totalRegistros}</div>
                    <div><strong>Valor Total:</strong> R$ ${data.totalValor.toLocaleString('pt-BR')}</div>
                    <div><strong>Empresas Ãnicas:</strong> ${data.empresas.size}</div>
                    <div><strong>Tipos de Registro:</strong> ${Array.from(data.recordTypes).sort().join(', ')}</div>
                    <br>
                    <div><strong>Detalhes por PerÃ­odo:</strong></div>
                `;
                
                Array.from(data.periodos.values()).sort((a, b) => `${a.ano}${a.mes}`.localeCompare(`${b.ano}${b.mes}`)).forEach(periodo => {
                    debugHTML += `
                        <div style="margin-left: 20px;">
                            <strong>${periodo.descricao}:</strong> 
                            ${periodo.registros.length} registros, 
                            R$ ${periodo.totalValor.toLocaleString('pt-BR')}, 
                            ${periodo.arquivos.size} arquivos,
                            ${periodo.empresas.size} empresas
                        </div>
                    `;
                });
                
                debugContent.innerHTML = debugHTML;
            }
            
            function toggleDebug() {
                debugMode = !debugMode;
                debugInfo.style.display = debugMode ? 'block' : 'none';
                debugToggle.textContent = debugMode ? 'Ocultar Debug' : 'Mostrar Debug';
                
                if (debugMode && filteredData) {
                    updateDebugInfo(filteredData);
                }
            }
            
            function exportToExcel() {
                if (!analysisData) {
                    showError('Nenhum dado para exportar. Processe os arquivos primeiro.');
                    return;
                }

                try {
                    loading.style.display = 'block';
                    
                    setTimeout(() => {
                        const wb = XLSX.utils.book_new();
                        
                        // Aba: Resumo por PerÃ­odo
                        const periodoData = [
                            ['PerÃ­odo', 'Arquivos', 'Empresas', 'Total de Registros', 'Tipos de Registros', 'Valor Total', 'Itens Cadastrados', 'Registros C170', 'Valor C170']
                        ];
                        
                        Array.from(analysisData.periodos.values()).sort((a, b) => {
                            if (a.ano === 'N/A') return 1;
                            if (b.ano === 'N/A') return -1;
                            return `${a.ano}${a.mes}`.localeCompare(`${b.ano}${b.mes}`);
                        }).forEach(periodo => {
                            const totalC170 = periodo.registrosC170.reduce((sum, c170) => sum + c170.vlItem, 0);
                            periodoData.push([
                                periodo.descricao,
                                periodo.arquivos.size,
                                periodo.empresas.size,
                                periodo.totalRegistros,
                                Array.from(periodo.recordTypes).sort().join(', '),
                                periodo.totalValor,
                                periodo.items0200.size,
                                periodo.registrosC170.length,
                                totalC170
                            ]);
                        });
                        
                        const wsPeriodo = XLSX.utils.aoa_to_sheet(periodoData);
                        XLSX.utils.book_append_sheet(wb, wsPeriodo, 'Resumo por PerÃ­odo');
                        
                        // Aba: Totais por Registro
                        const registrosData = [
                            ['Tipo de Registro', 'DescriÃ§Ã£o', 'Quantidade Total', 'Valor Total', 'PerÃ­odos', 'Arquivos', 'Empresas']
                        ];
                        
                        Array.from(analysisData.registros.values()).sort((a, b) => b.total - a.total).forEach(registro => {
                            registrosData.push([
                                registro.registro,
                                getRegistroDescription(registro.registro),
                                registro.count,
                                registro.total,
                                registro.periodos.size,
                                registro.arquivos.size,
                                registro.empresas.size
                            ]);
                        });
                        
                        const wsRegistros = XLSX.utils.aoa_to_sheet(registrosData);
                        XLSX.utils.book_append_sheet(wb, wsRegistros, 'Totais por Registro');
                        
                        // Aba: Itens com Valores
                        const itensData = [
                            ['CÃ³digo', 'DescriÃ§Ã£o', 'Unidade', 'PerÃ­odo', 'Quantidade Total', 'Valor Total', 'Valor UnitÃ¡rio MÃ©dio', 'Qtde. C170', 'Arquivos', 'Empresas']
                        ];
                        
                        Array.from(analysisData.periodos.values()).forEach(periodo => {
                            periodo.itemsComValores.forEach(item => {
                                const valorUnitarioMedio = item.quantidadeTotal > 0 ? item.valorTotal / item.quantidadeTotal : 0;
                                itensData.push([
                                    item.codigo,
                                    item.descricao,
                                    item.unidade,
                                    item.periodo,
                                    item.quantidadeTotal,
                                    item.valorTotal,
                                    valorUnitarioMedio,
                                    item.registrosC170.length,
                                    item.arquivos.size,
                                    item.empresas.size
                                ]);
                            });
                        });
                        
                        const wsItens = XLSX.utils.aoa_to_sheet(itensData);
                        XLSX.utils.book_append_sheet(wb, wsItens, 'Itens com Valores');
                        
                        // Aba: Registros C170
                        const c170Data = [
                            ['PerÃ­odo', 'Arquivo', 'CNPJ', 'Nome Empresa', 'CÃ³digo Item', 'DescriÃ§Ã£o Item', 'DescriÃ§Ã£o Complementar', 'Quantidade', 'Unidade', 'Valor Item', 'Valor Desconto', 'Base ICMS', 'Valor ICMS']
                        ];
                        
                        Array.from(analysisData.periodos.values()).forEach(periodo => {
                            periodo.registrosC170.forEach(c170 => {
                                const item0200 = periodo.items0200.get(c170.codItem);
                                c170Data.push([
                                    periodo.descricao,
                                    c170.arquivo,
                                    c170.empresa.cnpj,
                                    c170.empresa.nome,
                                    c170.codItem,
                                    item0200?.descricao || '',
                                    c170.descricaoCompl,
                                    c170.qtd,
                                    c170.unid,
                                    c170.vlItem,
                                    c170.vlDesc,
                                    c170.vlBaseICMS,
                                    c170.vlICMS
                                ]);
                            });
                        });
                        
                        const wsC170 = XLSX.utils.aoa_to_sheet(c170Data);
                        XLSX.utils.book_append_sheet(wb, wsC170, 'Registros C170');
                        
                        // Aba: Cadastro de Itens
                        const registro0200Data = [
                            ['PerÃ­odo', 'Arquivo', 'CNPJ', 'Nome Empresa', 'CÃ³digo Item', 'DescriÃ§Ã£o', 'CÃ³digo Barras', 'Unidade', 'Tipo Item', 'CÃ³digo NCM']
                        ];
                        
                        Array.from(analysisData.periodos.values()).forEach(periodo => {
                            periodo.items0200.forEach(item => {
                                registro0200Data.push([
                                    periodo.descricao,
                                    item.arquivo,
                                    item.empresa.cnpj,
                                    item.empresa.nome,
                                    item.codigo,
                                    item.descricao,
                                    item.codBarras,
                                    item.unidade,
                                    getTipoItemDescription(item.tipoItem),
                                    item.codNCM
                                ]);
                            });
                        });
                        
                        const ws0200 = XLSX.utils.aoa_to_sheet(registro0200Data);
                        XLSX.utils.book_append_sheet(wb, ws0200, 'Cadastro de Itens');
                        
                        // Aba: Todos os Registros Detalhados
                        const detailsData = [
                            ['PerÃ­odo', 'Arquivo', 'CNPJ', 'Nome Empresa', 'Registro', 'Item CÃ³digo', 'Item DescriÃ§Ã£o', 'Valor', 'Data', 'Linha Completa']
                        ];
                        
                        Array.from(analysisData.periodos.values()).forEach(periodo => {
                            periodo.registros.forEach(record => {
                                detailsData.push([
                                    periodo.descricao,
                                    record.fileName,
                                    record.empresa.cnpj,
                                    record.empresa.nome,
                                    record.registro,
                                    record.itemCodigo,
                                    record.itemDescricao,
                                    record.valor,
                                    record.data,
                                    record.linha
                                ]);
                            });
                        });
                        
                        const wsDetails = XLSX.utils.aoa_to_sheet(detailsData);
                        XLSX.utils.book_append_sheet(wb, wsDetails, 'Todos os Registros');
                        
                        // Aba: Detalhes por Arquivo
                        const filesData = [
                            ['Arquivo', 'CNPJ', 'Nome Empresa', 'PerÃ­odo', 'MÃªs/Ano', 'Total de Registros', 'Tipos de Registros', 'Valor Total', 'Itens 0200', 'Registros C170']
                        ];
                        
                        analysisData.filesData.forEach(file => {
                            const periodo = file.periodo;
                            filesData.push([
                                file.fileName,
                                file.empresa.cnpj,
                                file.empresa.nome,
                                periodo ? `${periodo.dataInicio} a ${periodo.dataFim}` : 'NÃ£o identificado',
                                periodo ? `${periodo.mes}/${periodo.ano}` : 'N/A',
                                file.totalRegistros,
                                Array.from(new Set(file.allRecords.map(r => r.registro))).join(', '),
                                file.totalValor,
                                file.items0200.size,
                                file.registrosC170.length
                            ]);
                        });
                        
                        const wsFiles = XLSX.utils.aoa_to_sheet(filesData);
                        XLSX.utils.book_append_sheet(wb, wsFiles, 'Detalhes por Arquivo');
                        
                        // NOVA ABA: Empresas
                        const empresasData = [
                            ['CNPJ', 'Nome da Empresa', 'Arquivos', 'PerÃ­odos', 'Total de Registros', 'Valor Total', 'Itens Cadastrados', 'Registros C170']
                        ];
                        
                        Array.from(analysisData.empresas.values()).sort((a, b) => a.nome.localeCompare(b.nome)).forEach(empresa => {
                            empresasData.push([
                                empresa.cnpj,
                                empresa.nome,
                                empresa.arquivos.size,
                                empresa.periodos.size,
                                empresa.totalRegistros,
                                empresa.totalValor,
                                empresa.items0200,
                                empresa.registrosC170
                            ]);
                        });
                        
                        const wsEmpresas = XLSX.utils.aoa_to_sheet(empresasData);
                        XLSX.utils.book_append_sheet(wb, wsEmpresas, 'Empresas');
                        
                        const timestamp = new Date().toISOString().slice(0,19).replace(/:/g, '-');
                        const fileName = `analise_sped_${timestamp}.xlsx`;
                        
                        XLSX.writeFile(wb, fileName);
                        
                        loading.style.display = 'none';
                    }, 100);
                    
                } catch (error) {
                    console.error('Erro ao exportar para Excel:', error);
                    showError('Erro ao exportar para Excel: ' + error.message);
                    loading.style.display = 'none';
                }
            }
            
            function resetAnalysis() {
                resultsSection.style.display = 'none';
                error.style.display = 'none';
                debugContent.innerHTML = '';
                analysisData = null;
                filteredData = null;
                
                Object.keys(paginationState).forEach(tab => {
                    paginationState[tab].currentPage = 1;
                    paginationState[tab].totalPages = 1;
                    
                    let paginationElement;
                    if (tab === '0200') {
                        paginationElement = document.getElementById('pagination0200');
                    } else if (tab === 'empresas') {
                        paginationElement = document.getElementById('empresasPagination');
                    } else {
                        paginationElement = document.getElementById(`${tab}Pagination`);
                    }
                    
                    if (paginationElement) {
                        paginationElement.style.display = 'none';
                    }
                });
                
                filterEmpresa.value = '';
                filterAno.value = '';
                filterMes.value = '';
                filterRegistro.value = '';
                filterItemCodigo.value = '';
                filterItemDescricao.value = '';
                filterValorMin.value = '';
                filterValorMax.value = '';
                
                periodoView = true;
                togglePeriodoView.textContent = 'Vista Consolidada';
                document.querySelectorAll('#itensTab, #c170Tab, #tab0200, #detailsTab').forEach(table => {
                    table.classList.remove('view-consolidada');
                });
            }
            
            function showError(message) {
                error.textContent = message;
                error.style.display = 'block';
            }
            
            function getRegistroDescription(registro) {
                const descriptions = {
                    '0000': 'Abertura do Arquivo Digital', '0001': 'Abertura do Bloco', '0005': 'Dados Complementares',
                    '0100': 'Dados do Contabilista', '0150': 'Cadastro de Participantes', '0190': 'IdentificaÃ§Ã£o das Unidades de Medida',
                    '0200': 'Cadastro de Item', '0400': 'Cadastro de Natureza da OperaÃ§Ã£o', '0450': 'Cadastro de InformaÃ§Ã£o Complementar',
                    '0500': 'Contas ContÃ¡beis', '0600': 'Centro de Custos', 'C001': 'Abertura do Bloco C',
                    'C100': 'Nota Fiscal', 'C170': 'Itens da Nota Fiscal', 'C190': 'Registro AnalÃ­tico do ICMS',
                    'C500': 'Nota Fiscal de Energia ElÃ©trica', 'C600': 'ConsolidaÃ§Ã£o DiÃ¡ria', 'D001': 'Abertura do Bloco D',
                    'D100': 'Nota Fiscal de ServiÃ§o', 'D500': 'Nota Fiscal de ServiÃ§o Consolidada', 'E001': 'Abertura do Bloco E',
                    'E100': 'PerÃ­odo da ApuraÃ§Ã£o', 'E110': 'Documentos Fiscais', 'E116': 'ObrigaÃ§Ãµes do ICMS'
                };
                return descriptions[registro] || 'Registro nÃ£o identificado';
            }
            
            function getTipoItemDescription(tipo) {
                const tipos = {
                    '00': 'Mercadoria para Revenda', '01': 'MatÃ©ria-prima', '02': 'Embalagem',
                    '03': 'Produto em Processo', '04': 'Produto Acabado', '05': 'Subproduto',
                    '06': 'Produto IntermediÃ¡rio', '07': 'Material de Uso e Consumo', '08': 'Ativo Imobilizado',
                    '09': 'ServiÃ§os', '10': 'Outros insumos', '99': 'Outras'
                };
                return tipo ? `${tipo} - ${tipos[tipo] || 'Desconhecido'}` : 'NÃ£o informado';
            }

            // CORREÃÃO: FunÃ§Ã£o para monitorar uso de memÃ³ria
            function updateMemoryUsage() {
                if (performance.memory) {
                    const usedMB = Math.round(performance.memory.usedJSHeapSize / 1048576);
                    const totalMB = Math.round(performance.memory.totalJSHeapSize / 1048576);
                    memoryUsageText.textContent = `${usedMB} MB / ${totalMB} MB`;
                    memoryUsage.style.display = 'block';
                    
                    // Aviso se estiver perto do limite
                    if (usedMB > 800) {
                        memoryUsage.style.background = '#fef2f2';
                        memoryUsage.style.borderColor = '#ef4444';
                    } else {
                        memoryUsage.style.background = '#fef3c7';
                        memoryUsage.style.borderColor = '#f59e0b';
                    }
                }
            }
        });
    </script>
</body>
</html>
